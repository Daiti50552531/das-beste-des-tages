<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Das Beste des Tages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#ddd; --muted:#666; --active:#2b8a3e; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px; }
    .card { max-width: 640px; margin: 0 auto; padding: 16px; border:1px solid var(--border); border-radius:12px; }
    .row { margin: 12px 0; }
    input, textarea, button { font-size:16px; }
    textarea { width:100%; padding:10px; resize: vertical; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color:var(--muted); font-size:14px; }
    .list { margin-top:12px; }
    .hide { display:none; }

    .moods { display:flex; gap:10px; }
    .mood-btn {
      font-size:22px; line-height:1; border:1px solid var(--border); border-radius:8px;
      background:#fff; padding:8px 10px; cursor:pointer; transition: transform .05s, border-color .1s;
    }
    .mood-btn:active { transform: scale(0.98); }
    .mood-btn.active { border-color: var(--active); box-shadow: inset 0 0 0 2px #2b8a3e33; }
    .entry { padding:8px 0; border-bottom:1px solid #eee; }
    .entry-date { font-weight: 600; }
    .two-cols { display:flex; gap:10px; flex-wrap: wrap; }
    .two-cols > * { flex:1 1 240px; }
  </style>
  https://esm.sh/@supabase/supabase-js@2</script>
</head>
<body>
  <!-- Auth Card -->
  <div id="auth" class="card">
    <h2>Anmelden</h2>
    <div class="two-cols">
      <form id="signup-form">
        <h3>Registrieren</h3>
        <div class="row"><input id="su-email" type="email" placeholder="E-Mail" required></div>
        <div class="row"><input id="su-pass"  type="password" placeholder="Passwort (min. 6 Zeichen)" required></div>
        <div class="row"><button type="submit">Registrieren</button></div>
        <div class="muted">Du bekommst eine Eâ€‘Mail zur BestÃ¤tigung, wenn â€Confirm emailâ€œ aktiv ist.</div>
      </form>
      <form id="login-form">
        <h3>Login</h3>
        <div class="row"><input id="li-email" type="email" placeholder="E-Mail" required></div>
        <div class="row"><input id="li-pass"  type="password" placeholder="Passwort" required></div>
        <div class="row"><button type="submit">Einloggen</button></div>
      </form>
    </div>
    <div class="row">
      <form id="magic-form">
        <h3>Magicâ€‘Link (optional)</h3>
        <div class="row"><input id="ml-email" type="email" placeholder="E-Mail" required></div>
        <div class="row"><button type="submit">Link an meine Eâ€‘Mail senden</button></div>
      </form>
    </div>
    <pre id="auth-out" class="muted"></pre>
  </div>

  <!-- App Card -->
  <div id="app" class="card hide">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h2>Das Beste des Tages</h2>
      <button id="logout">ğŸŒ™ Logout</button>
    </div>

    <div class="row">
      <label>Wie war deine Stimmung?</label>
      <div class="moods">
        <button class="mood-btn" data-score="1" type="button" title="traurig">ğŸ˜</button>
        <button class="mood-btn" data-score="2" type="button" title="neutral">ğŸ˜</button>
        <button class="mood-btn" data-score="3" type="button" title="frÃ¶hlich">ğŸ™‚</button>
      </div>
    </div>

    <div class="row">
      <textarea id="note" rows="3" placeholder="Notizâ€¦ (wird in text_field_1 gespeichert)"></textarea>
    </div>

    <div class="row toolbar">
      <button id="save"   type="button">Eintrag speichern</button>
      <button id="export" type="button">ğŸ“¥ Export CSV</button>
      <input  id="import-file" type="file" accept=".csv" />
      <button id="import" type="button">ğŸ“¤ Import CSV</button>
    </div>

    <h3>Meine EintrÃ¤ge</h3>
    <div id="entries" class="list"></div>
  </div>

  <script>
    // ======= Supabase Init =======
    const SUPABASE_URL = "https://xxxxxxxxxxxx.supabase.co";   // <-- anpassen
    const SUPABASE_ANON_KEY = "eyJhbGciOi...";                  // <-- anpassen
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======= UI Helpers =======
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove('hide');
    const hide = (id) => $(id).classList.add('hide');

    let moodScore = null;
    const moodButtons = Array.from(document.querySelectorAll('.mood-btn'));
    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        moodScore = parseInt(btn.dataset.score, 10);
        moodButtons.forEach(b => b.classList.toggle('active', b === btn));
      });
    });

    const renderEntries = (rows=[]) => {
      const root = $('entries');
      if (!rows.length) {
        root.innerHTML = '<div class="muted">Noch keine EintrÃ¤ge.</div>'; return;
      }
      root.innerHTML = rows.map(r => `
        <div class="entry">
          <div class="entry-date">${(r.entry_date || r.created_at || '').toString().slice(0,10)} â€“ ${r.mood_score ?? ''}</div>
          <div>${(r.text_field_1 || '').replace(/</g,'&lt;')}</div>
        </div>
      `).join('');
    };

    async function loadEntries() {
      const { data, error } = await client
        .from('diary_entries')
        .select('*')
        .order('entry_date', { ascending: false })
        .order('created_at', { ascending: false });
      if (error) { console.error(error); alert('Laden fehlgeschlagen: ' + error.message); return; }
      renderEntries(data || []);
    }

    async function ensureSession() {
      const { data: { session } } = await client.auth.getSession();
      if (session) { hide('auth'); show('app'); await loadEntries(); }
      else { show('auth'); hide('app'); }
    }

    // ======= Auth: Sign-up / Login / Magic =======
    $('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('su-email').value.trim();
      const password = $('su-pass').value;
      const { data, error } = await client.auth.signUp({
        email, password,
        options: { emailRedirectTo: `${location.origin}${location.pathname}` } // zurÃ¼ck auf deine Seite
      });
      $('auth-out').textContent = error ? error.message :
        (data?.user?.identities?.length ? 'Registriert. Bitte E-Mail bestÃ¤tigen.' : 'Wenn die E-Mail schon existiert: bitte einfach einloggen.');
    });

    $('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('li-email').value.trim();
      const password = $('li-pass').value;
      const { error } = await client.auth.signInWithPassword({ email, password });
      $('auth-out').textContent = error ? error.message : '';
      await ensureSession();
    });

    $('magic-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('ml-email').value.trim();
      const { error } = await client.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: `${location.origin}${location.pathname}` }
      });
      $('auth-out').textContent = error ? error.message : 'Magicâ€‘Link gesendet. Bitte Posteingang prÃ¼fen.';
    });

    $('logout').addEventListener('click', async () => {
      await client.auth.signOut();
      await ensureSession();
    });

    // ======= Eintrag speichern =======
    $('save').addEventListener('click', async () => {
      const note = $('note').value.trim();
      if (!moodScore && !note) return alert('Bitte Stimmung oder Notiz eingeben.');

      // entry_date = heute, Format YYYY-MM-DD (passt zu column DATE)
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const entry_date = `${yyyy}-${mm}-${dd}`;

      const { error } = await client.from('diary_entries').insert([{
        entry_date,
        text_field_1: note || null,
        text_field_2: null, // optional
        text_field_3: null, // optional
        mood_score: moodScore ?? null
        // user_id NICHT mitsenden -> default auth.uid() setzt es automatisch
      }]);
      if (error) return alert('Speichern fehlgeschlagen: ' + error.message);

      $('note').value = '';
      moodScore = null;
      moodButtons.forEach(b => b.classList.remove('active'));
      await loadEntries();
    });

    // ======= Export / Import =======
    $('export').addEventListener('click', async () => {
      const { data, error } = await client
        .from('diary_entries')
        .select('entry_date, mood_score, text_field_1')
        .order('entry_date', { ascending: true });
      if (error) return alert('Export fehlgeschlagen: ' + error.message);

      const header = ['entry_date','mood_score','text_field_1'];
      const lines = [header.join(',')].concat(
        (data || []).map(r => {
          const vals = [r.entry_date, r.mood_score, (r.text_field_1 || '').replace(/"/g,'""')];
          return vals.map(v => `"${(v ?? '')}"`).join(',');
        })
      );
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'diary_entries.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('import').addEventListener('click', async () => {
      const file = $('import-file').files[0];
      if (!file) return alert('Bitte CSV auswÃ¤hlen.');
      const text = await file.text();
      const rows = text.split(/\r?\n/).slice(1).filter(Boolean).map(line => {
        const m = line.match(/^"([^"]*)","([^"]*)","([^"]*)"$/);
        if (!m) return null;
        return { entry_date: m[1], mood_score: parseInt(m[2]||'0',10)||null, text_field_1: m[3].replace(/""/g,'"') };
      }).filter(Boolean);
      const { error } = await client.from('diary_entries').insert(rows);
      if (error) return alert('Import fehlgeschlagen: ' + error.message);
      await loadEntries();
    });

    // Session-Ã„nderungen beachten (z. B. nach E-Mail-BestÃ¤tigung)
    client.auth.onAuthStateChange(async () => { await ensureSession(); });

    // Start
    ensureSession();
  </script>
</body>
</html>
