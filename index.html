<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Das Beste des Tages</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- SheetJS fÃ¼r Excel-Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: #334155;
      --primary: #22c55e;
      --primary-hover: #16a34a;
      --danger: #ef4444;
      --danger-hover: #dc2626;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    h1, h2 {
      margin-bottom: 16px;
    }
    
    h1 {
      font-size: 28px;
      text-align: center;
    }
    
    h2 {
      font-size: 20px;
    }
    
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      color: var(--muted);
      margin: 12px 0 6px;
      font-weight: 500;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--border);
      color: var(--text);
    }
    
    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: var(--primary);
      color: #052e16;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: var(--danger-hover);
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .row > * {
      flex: 1;
      min-width: 200px;
    }
    
    .mood-buttons {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    
    .mood-btn {
      flex: 1;
      font-size: 32px;
      padding: 16px;
      background: var(--bg);
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mood-btn:hover {
      border-color: var(--primary);
    }
    
    .mood-btn.selected {
      border-color: var(--primary);
      background: rgba(34, 197, 94, 0.1);
      transform: scale(1.05);
    }
    
    .entries-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .entry-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      position: relative;
    }
    
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .entry-date {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
    }
    
    .entry-mood {
      font-size: 24px;
    }
    
    .entry-content p {
      margin: 8px 0;
      font-size: 14px;
    }
    
    .entry-content strong {
      color: var(--muted);
      font-size: 13px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .message.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }
    
    .message.info {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid var(--muted);
      color: var(--muted);
    }
    
    .hidden {
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-email {
      font-size: 14px;
      color: var(--muted);
    }
    
    @media (max-width: 640px) {
      .row {
        flex-direction: column;
      }
      
      .row > * {
        min-width: 100%;
      }
      
      .topbar {
        flex-direction: column;
        gap: 12px;
      }
      
      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Section -->
    <div id="authSection">
      <div class="card">
        <h1>Das Beste des Tages</h1>
        <p style="text-align: center; color: var(--muted); margin-bottom: 24px;">
          Dein persÃ¶nliches Tagebuch
        </p>
        
        <div class="row">
          <div>
            <label>E-Mail</label>
            <input type="email" id="authEmail" placeholder="deine@email.de" autocomplete="email">
          </div>
          <div>
            <label>Passwort</label>
            <input type="password" id="authPassword" placeholder="Mindestens 6 Zeichen" autocomplete="current-password">
          </div>
        </div>
        
        <div class="row" style="margin-top: 16px;">
          <button id="loginBtn" class="btn-primary">Einloggen</button>
          <button id="signupBtn">Registrieren</button>
        </div>
        
        <div id="authMessage"></div>
      </div>
    </div>
    
    <!-- App Section -->
    <div id="appSection" class="hidden">
      <div class="topbar">
        <h1>Das Beste des Tages</h1>
        <div class="user-info">
          <span id="userEmail" class="user-email"></span>
          <button id="logoutBtn" class="btn-small">Logout</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Neuer Eintrag</h2>
        
        <div class="row">
          <div>
            <label>Datum</label>
            <input type="date" id="entryDate">
          </div>
          <div>
            <label>Wie war deine Stimmung?</label>
            <div class="mood-buttons">
              <button class="mood-btn" data-mood="sad" type="button">ğŸ˜</button>
              <button class="mood-btn" data-mood="neutral" type="button">ğŸ˜</button>
              <button class="mood-btn" data-mood="happy" type="button">ğŸ™‚</button>
            </div>
          </div>
        </div>
        
        <label>Das Beste des Tages</label>
        <textarea id="bestOfDay" placeholder="Was war heute besonders schÃ¶n?"></textarea>
        
        <div class="row">
          <div>
            <label>ğŸ‘¶ Lotta</label>
            <input type="text" id="lotta" placeholder="Erlebnisse mit Lotta">
          </div>
          <div>
            <label>ğŸ‘§ Thea</label>
            <input type="text" id="thea" placeholder="Erlebnisse mit Thea">
          </div>
        </div>
        
        <div class="row" style="margin-top: 16px;">
          <button id="saveBtn" class="btn-primary">Eintrag speichern</button>
          <button id="exportCsvBtn">ğŸ“¥ CSV Export</button>
          <button id="exportXlsxBtn">ğŸ“¥ Excel Export</button>
          <label style="margin: 0;">
            <button type="button">ğŸ“¤ Import</button>
            <input type="file" id="importFile" accept=".csv,.xlsx" class="hidden">
          </label>
        </div>
        
        <div id="saveMessage"></div>
      </div>
      
      <div class="card">
        <h2>Meine EintrÃ¤ge</h2>
        <div id="entriesContainer" class="entries-grid"></div>
      </div>
    </div>
  </div>
  
  <script>
    console.log('ğŸš€ App startet...');
    
    // Supabase initialisieren
    const SUPABASE_URL = 'https://gaosbiyccwawuzfjagvm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhb3NiaXljY3dhd3V6ZmphZ3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDYzODAsImV4cCI6MjA3ODY4MjM4MH0.s30-UTEY1xR3DP521ewc03aMRsG3WLH_I5VTi4_xu-4';
    
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    console.log('âœ… Supabase Client erstellt');
    
    // DOM Elemente
    const authSection = document.getElementById('authSection');
    const appSection = document.getElementById('appSection');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');
    const authMessage = document.getElementById('authMessage');
    
    const entryDate = document.getElementById('entryDate');
    const bestOfDay = document.getElementById('bestOfDay');
    const lotta = document.getElementById('lotta');
    const thea = document.getElementById('thea');
    const saveBtn = document.getElementById('saveBtn');
    const saveMessage = document.getElementById('saveMessage');
    const entriesContainer = document.getElementById('entriesContainer');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportXlsxBtn = document.getElementById('exportXlsxBtn');
    const importFile = document.getElementById('importFile');
    
    let currentUser = null;
    let selectedMood = null;
    
    // Heutiges Datum setzen
    entryDate.value = new Date().toISOString().split('T')[0];
    
    // Auth State prÃ¼fen
    supabase.auth.getSession().then(({ data: { session } }) => {
      console.log('ğŸ“ Session Check:', session ? 'Eingeloggt' : 'Ausgeloggt');
      if (session) {
        showApp(session.user);
      } else {
        showAuth();
      }
    });
    
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('ğŸ”„ Auth Event:', event);
      if (event === 'SIGNED_IN' && session) {
        showApp(session.user);
      } else if (event === 'SIGNED_OUT') {
        showAuth();
      }
    });
    
    function showAuth() {
      authSection.classList.remove('hidden');
      appSection.classList.add('hidden');
      currentUser = null;
    }
    
    function showApp(user) {
      currentUser = user;
      authSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      userEmail.textContent = user.email;
      loadEntries();
    }
    
    function showMessage(element, text, type = 'info') {
      element.innerHTML = `<div class="message ${type}">${text}</div>`;
      if (type === 'success') {
        setTimeout(() => element.innerHTML = '', 3000);
      }
    }
    
    // Login
    loginBtn.addEventListener('click', async () => {
      console.log('ğŸ” Login-Versuch...');
      const email = authEmail.value.trim();
      const password = authPassword.value;
      
      if (!email || !password) {
        showMessage(authMessage, 'Bitte E-Mail und Passwort eingeben', 'error');
        return;
      }
      
      showMessage(authMessage, 'Anmelden...', 'info');
      
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      
      if (error) {
        console.error('âŒ Login Fehler:', error);
        showMessage(authMessage, 'Login fehlgeschlagen: ' + error.message, 'error');
      } else {
        console.log('âœ… Login erfolgreich');
        showMessage(authMessage, 'Erfolgreich angemeldet!', 'success');
      }
    });
    
    // Registrierung
    signupBtn.addEventListener('click', async () => {
      console.log('ğŸ“ Registrierungs-Versuch...');
      const email = authEmail.value.trim();
      const password = authPassword.value;
      
      if (!email || !password) {
        showMessage(authMessage, 'Bitte E-Mail und Passwort eingeben', 'error');
        return;
      }
      
      if (password.length < 6) {
        showMessage(authMessage, 'Passwort muss mindestens 6 Zeichen haben', 'error');
        return;
      }
      
      showMessage(authMessage, 'Registriere...', 'info');
      
      const { data, error } = await supabase.auth.signUp({ email, password });
      
      if (error) {
        console.error('âŒ Registrierung Fehler:', error);
        showMessage(authMessage, 'Registrierung fehlgeschlagen: ' + error.message, 'error');
      } else {
        console.log('âœ… Registrierung erfolgreich');
        showMessage(authMessage, 'Registrierung erfolgreich! Du kannst dich jetzt einloggen.', 'success');
      }
    });
    
    // Logout
    logoutBtn.addEventListener('click', async () => {
      console.log('ğŸ‘‹ Logout...');
      await supabase.auth.signOut();
    });
    
    // Mood Selection
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
        console.log('ğŸ˜Š Stimmung gewÃ¤hlt:', selectedMood);
      });
    });
    
    // Eintrag speichern
    saveBtn.addEventListener('click', async () => {
      console.log('ğŸ’¾ Speichere Eintrag...');
      
      if (!selectedMood) {
        showMessage(saveMessage, 'Bitte wÃ¤hle eine Stimmung aus', 'error');
        return;
      }
      
      if (!currentUser) {
        showMessage(saveMessage, 'Nicht eingeloggt', 'error');
        return;
      }
      
      showMessage(saveMessage, 'Speichere...', 'info');
      
      const entry = {
        user_id: currentUser.id,
        entry_date: entryDate.value,
        best_of_day: bestOfDay.value || null,
        lotta: lotta.value || null,
        thea: thea.value || null,
        mood: selectedMood
      };
      
      console.log('ğŸ“¦ Eintrag Daten:', entry);
      
      const { data, error } = await supabase.from('entries').insert(entry);
      
      if (error) {
        console.error('âŒ Speichern Fehler:', error);
        showMessage(saveMessage, 'Fehler beim Speichern: ' + error.message, 'error');
      } else {
        console.log('âœ… Eintrag gespeichert');
        showMessage(saveMessage, 'Eintrag gespeichert! âœ…', 'success');
        
        // Formular zurÃ¼cksetzen
        bestOfDay.value = '';
        lotta.value = '';
        thea.value = '';
        selectedMood = null;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        entryDate.value = new Date().toISOString().split('T')[0];
        
        loadEntries();
      }
    });
    
    // EintrÃ¤ge laden
    async function loadEntries() {
      console.log('ğŸ“¥ Lade EintrÃ¤ge...');
      entriesContainer.innerHTML = '<div class="loading">Lade EintrÃ¤ge...</div>';
      
      const { data, error } = await supabase
        .from('entries')
        .select('*')
        .order('entry_date', { ascending: false })
        .limit(100);
      
      if (error) {
        console.error('âŒ Laden Fehler:', error);
        entriesContainer.innerHTML = `<div class="message error">Fehler: ${error.message}</div>`;
        return;
      }
      
      console.log(`âœ… ${data.length} EintrÃ¤ge geladen`);
      
      if (data.length === 0) {
        entriesContainer.innerHTML = '<div class="message info">Noch keine EintrÃ¤ge vorhanden</div>';
        return;
      }
      
      entriesContainer.innerHTML = data.map(renderEntry).join('');
      
      // Delete Buttons
      document.querySelectorAll('[data-delete]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Eintrag wirklich lÃ¶schen?')) return;
          
          const id = btn.dataset.delete;
          console.log('ğŸ—‘ï¸ LÃ¶sche Eintrag:', id);
          
          const { error } = await supabase.from('entries').delete().eq('id', id);
          
          if (error) {
            console.error('âŒ LÃ¶schen Fehler:', error);
            alert('Fehler beim LÃ¶schen: ' + error.message);
          } else {
            console.log('âœ… Eintrag gelÃ¶scht');
            loadEntries();
          }
        });
      });
    }
    
    function renderEntry(entry) {
      const moodEmoji = entry.mood === 'happy' ? 'ğŸ™‚' : entry.mood === 'neutral' ? 'ğŸ˜' : entry.mood === 'sad' ? 'ğŸ˜' : 'â€”';
      const date = new Date(entry.entry_date).toLocaleDateString('de-DE', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      
      return `
        <div class="entry-card">
          <div class="entry-header">
            <span class="entry-date">${date}</span>
            <span class="entry-mood">${moodEmoji}</span>
          </div>
          <div class="entry-content">
            ${entry.best_of_day ? `<p><strong>Das Beste:</strong><br>${escapeHtml(entry.best_of_day)}</p>` : ''}
            ${entry.lotta ? `<p><strong>ğŸ‘¶ Lotta:</strong> ${escapeHtml(entry.lotta)}</p>` : ''}
            ${entry.thea ? `<p><strong>ğŸ‘§ Thea:</strong> ${escapeHtml(entry.thea)}</p>` : ''}
          </div>
          <button class="btn-danger btn-small" data-delete="${entry.id}" style="margin-top: 12px;">LÃ¶schen</button>
        </div>
      `;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // CSV Export
    exportCsvBtn.addEventListener('click', async () => {
      console.log('ğŸ“¥ Exportiere CSV...');
      
      const { data, error } = await supabase
        .from('entries')
        .select('*')
        .order('entry_date', { ascending: true });
      
      if (error) {
        alert('Fehler: ' + error.message);
        return;
      }
      
      const headers = ['entry_date', 'best_of_day', 'lotta', 'thea', 'mood'];
      const csv = [
        headers.join(','),
        ...data.map(row => headers.map(h => {
          const val = row[h] || '';
          return `"${String(val).replace(/"/g, '""')}"`;
        }).join(','))
      ].join('\n');
      
      downloadFile(csv, 'tagebuch-export.csv', 'text/csv');
      console.log('âœ… CSV exportiert');
    });
    
    // Excel Export
    exportXlsxBtn.addEventListener('click', async () => {
      console.log('ğŸ“¥ Exportiere Excel...');
      
      const { data, error } = await supabase
        .from('entries')
        .select('entry_date, best_of_day, lotta, thea, mood')
        .order('entry_date', { ascending: true });
      
      if (error) {
        alert('Fehler: ' + error.message);
        return;
      }
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'EintrÃ¤ge');
      
      XLSX.writeFile(wb, 'tagebuch-export.xlsx');
      console.log('âœ… Excel exportiert');
    });
    
    // Import
    importFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      console.log('ğŸ“¤ Importiere:', file.name);
      
      try {
        let data;
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (ext === 'csv') {
          const text = await file.text();
          data = parseCSV(text);
        } else {
          const buffer = await file.arrayBuffer();
          const wb = XLSX.read(buffer);
          data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        }
        
        const entries = data.map(row => ({
          user_id: currentUser.id,
          entry_date: row.entry_date || row.date || new Date().toISOString().split('T')[0],
          best_of_day: row.best_of_day || row.best || null,
          lotta: row.lotta || null,
          thea: row.thea || null,
          mood: ['sad', 'neutral', 'happy'].includes(row.mood) ? row.mood : 'neutral'
        }));
        
        const { error } = await supabase.from('entries').insert(entries);
        
        if (error) {
          alert('Fehler beim Import: ' + error.message);
        } else {
          alert(`${entries.length} EintrÃ¤ge importiert! âœ…`);
          loadEntries();
        }
      } catch (error) {
        alert('Import-Fehler: ' + error.message);
      }
      
      importFile.value = '';
    });
    
    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      
      return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i] || '');
        return obj;
      });
    }
    
    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    console.log('âœ… App bereit!');
  </script>
</body>
</html>
