<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Das Beste des Tages</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- SheetJS fÃ¼r Excel-Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: #334155;
      --primary: #22c55e;
      --primary-hover: #16a34a;
      --danger: #ef4444;
      --danger-hover: #dc2626;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
    }

    /* Card Styling */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Form Styling */
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--muted);
    }
    
    input[type="date"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      resize: vertical;
    }

    textarea {
        min-height: 100px;
    }

    /* Button Styling */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--bg);
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
    }
    
    .btn-danger {
      background: var(--danger);
      color: var(--text);
    }
    
    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-group {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }

    /* Mood Selection */
    .mood-selector {
        display: flex;
        gap: 15px;
        margin-top: 5px;
        justify-content: center;
    }

    .mood-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.2s;
        border: 2px solid transparent;
    }

    .mood-option:hover {
        background: var(--bg);
    }

    .mood-option.selected {
        border-color: var(--primary);
        background: var(--bg);
    }

    .mood-icon {
        font-size: 2rem;
        transition: transform 0.2s;
    }

    .mood-option:hover .mood-icon {
        transform: scale(1.1);
    }

    /* Entry List Styling */
    #entries-list {
      display: grid;
      gap: 15px;
    }
    
    .entry-item {
      background: var(--card);
      border-left: 5px solid var(--primary);
      padding: 15px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
    }
    
    .entry-date {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .entry-content p {
        margin-bottom: 8px;
        padding-left: 10px;
        border-left: 2px solid var(--border);
    }

    .entry-content strong {
        color: var(--muted);
        display: block;
        margin-left: -12px; /* Zieht den Label-Text etwas nach links */
    }

    .mood-display {
        font-size: 1.5rem;
        line-height: 1;
        margin-right: 5px;
    }

    /* Import/Export */
    .import-export-controls {
        display: flex;
        gap: 10px;
        justify-content: space-between;
        flex-wrap: wrap;
    }

    .import-export-controls > div {
        display: flex;
        gap: 10px;
    }

    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }

    /* Loader */
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div></div>

  <div class="container">
    <h1>Das Beste des Tages</h1>

    <!-- Import/Export Card -->
    <div class="card">
        <h2>Daten-Tools</h2>
        <div class="import-export-controls">
            <div>
                <button id="export-btn" class="btn btn-primary">Exportieren (Excel)</button>
            </div>
            <div>
                <div class="file-input-wrapper">
                    <button class="btn btn-primary">Importieren (CSV)</button>
                    <input type="file" id="import-file" accept=".csv">
                </div>
            </div>
        </div>
    </div>

    <!-- Entry Form Card -->
    <div class="card">
      <div class="form-group">
        <label for="entry-date">Datum</label>
        <input type="date" id="entry-date">
      </div>

      <div class="form-group">
        <label for="best-of-day">Das Beste (Bete)</label>
        <textarea id="best-of-day" placeholder="Was war dein Highlight des Tages?"></textarea>
      </div>

      <div class="form-group">
        <label for="lotta">Lotta</label>
        <textarea id="lotta" placeholder="Lottas Highlight"></textarea>
      </div>

      <div class="form-group">
        <label for="thea">Thea</label>
        <textarea id="thea" placeholder="Theas Highlight"></textarea>
      </div>

      <div class="form-group">
        <label>Stimmung</label>
        <div class="mood-selector" id="mood-selector">
            <div class="mood-option" data-mood="sad">
                <span class="mood-icon">ğŸ˜</span>
                <span>Traurig</span>
            </div>
            <div class="mood-option selected" data-mood="neutral">
                <span class="mood-icon">ğŸ˜</span>
                <span>Neutral</span>
            </div>
            <div class="mood-option" data-mood="happy">
                <span class="mood-icon">ğŸ˜„</span>
                <span>GlÃ¼cklich</span>
            </div>
        </div>
      </div>
      
      <div class="btn-group">
        <button id="delete-btn" class="btn btn-danger" style="display: none;">LÃ¶schen</button>
        <button id="save-btn" class="btn btn-primary">Speichern</button>
      </div>
    </div>

    <!-- Entries List Card -->
    <div class="card">
      <h2>Deine EintrÃ¤ge</h2>
      <div id="entries-list">
        <!-- EintrÃ¤ge werden hier eingefÃ¼gt -->
        <p id="no-entries-message" style="color: var(--muted);">Noch keine EintrÃ¤ge vorhanden.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Globale Variablen aus dem Canvas-Environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Supabase Setup ---
    // Dies muss an die korrekten Supabase-Daten angepasst werden!
    const SUPABASE_URL = firebaseConfig.supabaseUrl || 'YOUR_SUPABASE_URL'; 
    const SUPABASE_ANON_KEY = firebaseConfig.supabaseAnonKey || 'YOUR_SUPABASE_ANON_KEY';
    
    let supabase = null;
    let auth = null;
    let userId = null;
    let currentEntryId = null; // FÃ¼r den Bearbeitungsmodus
    let allEntries = []; // Speichert alle EintrÃ¤ge fÃ¼r Export und Anzeige

    // --- DOM Elemente ---
    const entryDateInput = document.getElementById('entry-date');
    const bestOfDayInput = document.getElementById('best-of-day');
    const lottaInput = document.getElementById('lotta');
    const theaInput = document.getElementById('thea');
    const moodSelector = document.getElementById('mood-selector');
    const saveBtn = document.getElementById('save-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const entriesList = document.getElementById('entries-list');
    const noEntriesMessage = document.getElementById('no-entries-message');
    const exportBtn = document.getElementById('export-btn');
    const importFile = document.getElementById('import-file');
    const loader = document.getElementById('loader');

    // --- Initialisierung ---

    function showLoader() { loader.style.display = 'flex'; }
    function hideLoader() { loader.style.display = 'none'; }

    function getDBPath(collectionName) {
        return `artifacts/${appId}/users/${userId}/${collectionName}`;
    }

    async function initializeApp() {
        showLoader();
        try {
            // Initialisiere Supabase
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                console.error("Bitte ersetze 'YOUR_SUPABASE_URL' und 'YOUR_SUPABASE_ANON_KEY' durch deine tatsÃ¤chlichen Werte.");
                return;
            }
            supabase = supabase_js.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Da Supabase keine direkte Custom Token Auth wie Firebase hat,
            // Ã¼berspringen wir die Firebase Auth und verwenden Supabase, 
            // oder melden uns bei einer hypothetischen Firebase-Instanz an, 
            // um eine user id zu erhalten (falls das Canvas-Backend Firebase erwartet).
            // Hier verwenden wir eine einfache zufÃ¤llige ID als Platzhalter,
            // da die Supabase-Auth-Details fehlen und Supabase direkt angesprochen wird.
            userId = 'guest-' + crypto.randomUUID();
            
            // Setze das heutige Datum
            entryDateInput.value = new Date().toISOString().split('T')[0];
            
            loadEntries();
            
        } catch (error) {
            console.error("Fehler bei der Initialisierung:", error);
            alert("Fehler bei der Initialisierung der App. Bitte Ã¼berprÃ¼fe die Konfiguration.");
        } finally {
            hideLoader();
        }
    }

    // --- Funktionen ---

    /**
     * Konvertiert Datums-Strings in das YYYY-MM-DD-Format.
     * UnterstÃ¼tzt gÃ¤ngige Formate wie DD.MM.YYYY und YYYY-MM-DD.
     * @param {string} dateString 
     * @returns {string | null} YYYY-MM-DD String oder null bei Fehler
     */
    function parseDate(dateString) {
        if (!dateString) return null;
        dateString = dateString.trim();

        // 1. Versucht, DD.MM.YYYY oder DD/MM/YYYY in YYYY-MM-DD umzuwandeln
        const parts = dateString.match(/(\d{1,2})[.\/](\d{1,2})[.\/](\d{4})/);
        if (parts) {
            // parts[3] = YYYY, parts[2] = MM, parts[1] = DD
            const [_, day, month, year] = parts;
            // Erstellt den ISO-konformen String
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        // 2. Versucht, das Datum direkt zu parsen (fÃ¼r YYYY-MM-DD oder andere Standardformate)
        const date = new Date(dateString);
        // PrÃ¼ft, ob das Date-Objekt gÃ¼ltig ist und nicht in der Ferne liegt (z.B. > Jahr 3000)
        if (!isNaN(date) && dateString && date.getFullYear() < 3000) {
            return date.toISOString().split('T')[0];
        }

        // Wenn alles fehlschlÃ¤gt, null zurÃ¼ckgeben
        return null;
    }


    function resetForm() {
      currentEntryId = null;
      entryDateInput.value = new Date().toISOString().split('T')[0];
      bestOfDayInput.value = '';
      lottaInput.value = '';
      theaInput.value = '';
      deleteBtn.style.display = 'none';
      saveBtn.textContent = 'Speichern';
      selectMood('neutral');
    }

    function selectMood(mood) {
        document.querySelectorAll('.mood-option').forEach(option => {
            option.classList.remove('selected');
            if (option.dataset.mood === mood) {
                option.classList.add('selected');
            }
        });
    }

    function getSelectedMood() {
        return document.querySelector('.mood-option.selected').dataset.mood;
    }

    async function loadEntries() {
        if (!supabase) return;
        
        showLoader();
        
        // Holt alle EintrÃ¤ge, sortiert nach Datum absteigend
        const { data, error } = await supabase
            .from('entries')
            .select('*')
            .order('date', { ascending: false });

        if (error) {
            console.error('Fehler beim Laden der EintrÃ¤ge:', error);
            hideLoader();
            return;
        }

        allEntries = data || [];
        renderEntries(allEntries);
        hideLoader();
    }

    function renderEntries(entries) {
      entriesList.innerHTML = '';
      if (entries.length === 0) {
        noEntriesMessage.style.display = 'block';
        return;
      }
      noEntriesMessage.style.display = 'none';

      entries.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'card entry-item';
        item.dataset.id = entry.id;

        const dateDisplay = new Date(entry.date).toLocaleDateString('de-DE', {
            weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit'
        });
        
        const moodEmoji = {
            'sad': 'ğŸ˜',
            'neutral': 'ğŸ˜',
            'happy': 'ğŸ˜„'
        }[entry.mood || 'neutral'];

        item.innerHTML = `
          <div class="entry-date">
            ${dateDisplay}
            <div>
                <span class="mood-display">${moodEmoji}</span>
                <button class="btn btn-primary btn-edit" data-id="${entry.id}">Bearbeiten</button>
            </div>
          </div>
          <div class="entry-content">
            ${entry.best_of_day ? `<strong>Beste:</strong> <p>${entry.best_of_day.replace(/\n/g, '<br>')}</p>` : ''}
            ${entry.lotta ? `<strong>Lotta:</strong> <p>${entry.lotta.replace(/\n/g, '<br>')}</p>` : ''}
            ${entry.thea ? `<strong>Thea:</strong> <p>${entry.thea.replace(/\n/g, '<br>')}</p>` : ''}
          </div>
        `;
        entriesList.appendChild(item);
      });

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const entry = allEntries.find(e => e.id == id);
          if (entry) {
            loadEntryForEdit(entry);
          }
        });
      });
    }

    function loadEntryForEdit(entry) {
      currentEntryId = entry.id;
      entryDateInput.value = entry.date;
      bestOfDayInput.value = entry.best_of_day || '';
      lottaInput.value = entry.lotta || '';
      theaInput.value = entry.thea || '';
      saveBtn.textContent = 'Ã„nderungen speichern';
      deleteBtn.style.display = 'inline-block';
      selectMood(entry.mood || 'neutral');
      // Scroll zum Formular
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    async function saveEntry() {
      showLoader();
      const entryDate = entryDateInput.value;
      const entry = {
        date: entryDate,
        best_of_day: bestOfDayInput.value.trim() || null,
        lotta: lottaInput.value.trim() || null,
        thea: theaInput.value.trim() || null,
        mood: getSelectedMood()
      };

      if (!entryDate) {
        alert('Bitte wÃ¤hle ein Datum aus.');
        hideLoader();
        return;
      }
      
      let error = null;
      
      if (currentEntryId) {
        // Update (Bearbeiten)
        const { error: updateError } = await supabase
            .from('entries')
            .update(entry)
            .eq('id', currentEntryId);
        error = updateError;
      } else {
        // Insert (Neu anlegen) - Nutzen Sie hier auch upsert, um Duplikate zu verhindern
        // Wenn bereits ein Eintrag fÃ¼r dieses Datum existiert, wird dieser aktualisiert.
        const { error: insertError } = await supabase
            .from('entries')
            .upsert(entry, { onConflict: 'date' });
        error = insertError;
      }

      if (error) {
        alert('Fehler beim Speichern: ' + error.message);
      } else {
        alert('Eintrag erfolgreich gespeichert! âœ…');
        resetForm();
        loadEntries();
      }
      hideLoader();
    }
    
    async function deleteEntry() {
        if (!currentEntryId) return;

        // Custom Modal-Ersatz fÃ¼r alert/confirm
        if (!confirm("Bist du sicher, dass du diesen Eintrag lÃ¶schen mÃ¶chtest?")) {
            return;
        }

        showLoader();
        const { error } = await supabase
            .from('entries')
            .delete()
            .eq('id', currentEntryId);

        if (error) {
            alert('Fehler beim LÃ¶schen: ' + error.message);
        } else {
            alert('Eintrag erfolgreich gelÃ¶scht! ğŸ—‘ï¸');
            resetForm();
            loadEntries();
        }
        hideLoader();
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      // Annahme: Header in der ersten Zeile, Komma als Trennzeichen
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\"/g, ''));
      
      return lines.slice(1).map(line => {
        // Nutzt regex, um Werte in AnfÃ¼hrungszeichen korrekt zu behandeln
        const values = line.match(/(".*?"|[^",\n]+)(,|$)/g) || [];
        
        const obj = {};
        headers.forEach((h, i) => {
            // Wert bereinigen (AnfÃ¼hrungszeichen entfernen, trimmen)
            obj[h] = (values[i] || '').replace(/,$/, '').replace(/^\"|\"$/g, '').trim();
        });
        return obj;
      });
    }

    async function handleImport(event) {
        if (!supabase) return;
        const file = event.target.files[0];
        if (!file) return;

        showLoader();

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const text = e.target.result;
                const parsedData = parseCSV(text);
                
                if (parsedData.length === 0) {
                    alert('Die Datei enthÃ¤lt keine Daten.');
                    hideLoader();
                    importFile.value = '';
                    return;
                }

                // Daten in das Datenbank-Format umwandeln und Datum parsen
                const entries = parsedData.map(row => {
                    // Ersetze 'date' mit 'datum' oder anderen mÃ¶glichen Header-Namen
                    const dateKey = Object.keys(row).find(k => k.includes('date') || k.includes('datum'));
                    const dateValue = dateKey ? row[dateKey] : null;

                    const parsedDate = parseDate(dateValue);

                    // UngÃ¼ltige Datumsangaben Ã¼berspringen
                    if (!parsedDate) {
                        console.warn('UngÃ¼ltiges Datum Ã¼bersprungen:', dateValue);
                        return null; 
                    }
                    
                    // Supabase-Spaltennamen:
                    return {
                        date: parsedDate,
                        // Verschiedene Header-Namen abfangen ('best' oder 'best_of_day')
                        best_of_day: row.best_of_day || row.best || null, 
                        lotta: row.lotta || null,
                        thea: row.thea || null,
                        mood: ['sad', 'neutral', 'happy'].includes(row.mood) ? row.mood : 'neutral'
                    };
                }).filter(e => e !== null); // UngÃ¼ltige EintrÃ¤ge filtern

                if (entries.length === 0) {
                    alert('Keine gÃ¼ltigen EintrÃ¤ge zum Importieren gefunden.');
                    hideLoader();
                    importFile.value = '';
                    return;
                }
                
                // *** WICHTIGE Ã„NDERUNG: UPSERT statt INSERT ***
                // upsert sorgt dafÃ¼r, dass EintrÃ¤ge mit demselben Datum ('date') 
                // zusammengefÃ¼hrt (aktualisiert) werden, anstatt Duplikate zu erstellen.
                const { error } = await supabase
                    .from('entries')
                    .upsert(entries, { onConflict: 'date' }); 
                
                if (error) {
                    alert('Fehler beim Import: ' + error.message);
                } else {
                    alert(`${entries.length} EintrÃ¤ge erfolgreich importiert/aktualisiert! âœ…`);
                    loadEntries();
                }
            } catch (error) {
                alert('Import-Fehler: ' + error.message);
            } finally {
                hideLoader();
                importFile.value = '';
            }
        };
        reader.readAsText(file);
    }

    function downloadFile(content, filename, mimeType) {
        const a = document.createElement('a');
        const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function handleExport() {
        if (allEntries.length === 0) {
            alert('Keine EintrÃ¤ge zum Exportieren vorhanden.');
            return;
        }

        const dataForExport = allEntries.map(entry => ({
            Datum: new Date(entry.date).toLocaleDateString('de-DE'),
            'Datum (ISO)': entry.date, // ISO Format als Backup
            'Das Beste (Bete)': entry.best_of_day || '',
            Lotta: entry.lotta || '',
            Thea: entry.thea || '',
            Stimmung: entry.mood || 'neutral'
        }));

        const ws = XLSX.utils.json_to_sheet(dataForExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Tagebuch");
        
        // Erzeugt eine Excel-Datei (.xlsx)
        XLSX.writeFile(wb, "Tagebuch_Export.xlsx");
        alert('Daten erfolgreich exportiert! ğŸ’¾');
    }

    // --- Event Listeners ---
    saveBtn.addEventListener('click', saveEntry);
    deleteBtn.addEventListener('click', deleteEntry);
    exportBtn.addEventListener('click', handleExport);
    importFile.addEventListener('change', handleImport);

    moodSelector.addEventListener('click', (e) => {
        const option = e.target.closest('.mood-option');
        if (option) {
            selectMood(option.dataset.mood);
        }
    });

    // Stellt sicher, dass das Formular geleert wird, wenn man ein neues Datum auswÃ¤hlt
    entryDateInput.addEventListener('change', () => {
        const existingEntry = allEntries.find(e => e.date === entryDateInput.value);
        if (!existingEntry) {
            // Nur zurÃ¼cksetzen, wenn es KEINEN Eintrag fÃ¼r dieses Datum gibt
            if (currentEntryId) {
                resetForm();
                entryDateInput.value = entryDateInput.value; // behÃ¤lt das neue Datum
            }
        } else {
            // Eintrag laden, wenn er existiert
            loadEntryForEdit(existingEntry);
        }
    });

    // Initialisierung starten
    initializeApp();
  </script>
</body>
</html>
