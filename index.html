<!Doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Journal 2025</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

  <style>
    :root {
      /* --- COLOR PALETTE (Apple Human Interface Guidelines) --- */
      --primary: #000000; 
      --primary-rgb: 0,0,0;
      
      --accent: #007AFF; /* iOS Blue */
      --success: #34C759; /* iOS Green */
      --danger: #FF3B30;  /* iOS Red */
      
      --bg-body: #F2F2F7; /* System Grouped Background */
      --bg-card: #FFFFFF;
      --bg-surface: #FFFFFF;
      --bg-input: #F2F2F7;
      --bg-button-secondary: #E5E5EA; /* System Gray 5 */
      
      --text-main: #000000;
      --text-secondary: #8E8E93;
      --text-tertiary: #C7C7CC;
      
      --border: rgba(0,0,0,0.08);
      --glass: rgba(255, 255, 255, 0.85);
      
      --radius-l: 24px;  /* Modern, rounder look */
      --radius-m: 16px;
      --radius-s: 12px;
      
      --shadow-card: 0 4px 20px rgba(0,0,0,0.03);
      --shadow-float: 0 12px 30px rgba(0,0,0,0.08);
      
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    }

    .dark-mode {
      --primary: #FFFFFF;
      --primary-rgb: 255,255,255;
      
      --bg-body: #000000;
      --bg-card: #1C1C1E; /* System Gray 6 */
      --bg-surface: #2C2C2E; /* System Gray 5 */
      --bg-input: #2C2C2E;
      --bg-button-secondary: #3A3A3C;
      
      --text-main: #FFFFFF;
      --text-secondary: #98989D;
      --text-tertiary: #505055;
      
      --border: rgba(255,255,255,0.08);
      --glass: rgba(30, 30, 30, 0.85);
      
      --shadow-card: 0 4px 20px rgba(0,0,0,0.2);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding-top: 80px;
      padding-bottom: 120px; /* Space for bottom area */
      min-height: 100vh;
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.4s ease;
    }

    /* --- ICONS (SVG Styling) --- */
    .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
    .icon-sm { width: 16px; height: 16px; }
    
    /* --- HEADER --- */
    .sticky-header-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 100;
        background: var(--glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
    }
    .topbar {
        max-width: 600px;
        margin: 0 auto;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .app-title {
        font-size: 17px;
        font-weight: 600; 
        color: var(--text-main);
        letter-spacing: -0.02em;
    }
    .theme-btn {
        background: var(--bg-button-secondary);
        border: none;
        width: 36px; height: 36px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: var(--text-main);
        cursor: pointer;
        transition: transform 0.2s;
    }
    .theme-btn:active { transform: scale(0.9); }

    /* --- LAYOUT --- */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .section-title {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        font-weight: 600;
        margin: 24px 0 10px 4px;
    }

    /* --- CARDS & SURFACES --- */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-l);
      box-shadow: var(--shadow-card);
      overflow: hidden;
      margin-bottom: 24px;
      position: relative;
    }
    
    /* --- DATE PICKER HACK --- */
    .date-wrapper {
        position: relative;
        background: var(--bg-button-secondary);
        border-radius: var(--radius-m);
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        margin-bottom: 20px;
        transition: background 0.2s;
    }
    .date-wrapper:hover { background: var(--bg-input); }
    .date-display { font-weight: 600; color: var(--text-main); font-size: 16px; }
    #entryDate {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* --- INPUTS --- */
    .input-group {
        padding: 20px;
    }
    label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }
    textarea, input[type="text"], input[type="email"], input[type="password"] {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: var(--radius-m);
        background: var(--bg-input);
        color: var(--text-main);
        font-family: var(--font-stack);
        font-size: 17px;
        line-height: 1.5;
        resize: none;
        transition: box-shadow 0.2s;
    }
    textarea:focus, input:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--accent);
        background: var(--bg-card);
    }
    
    /* --- MOOD SELECTOR (Segmented Style) --- */
    .mood-container {
        padding: 0 20px 20px 20px;
    }
    .mood-grid {
        display: flex;
        background: var(--bg-input);
        padding: 4px;
        border-radius: var(--radius-l);
        justify-content: space-between;
    }
    .mood-btn {
        flex: 1;
        border: none;
        background: transparent;
        padding: 12px;
        border-radius: var(--radius-m);
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        opacity: 0.4;
        filter: grayscale(100%);
    }
    .mood-btn.selected {
        background: var(--bg-card);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        opacity: 1;
        filter: grayscale(0%);
        transform: scale(1.05);
    }

    /* --- ACTION GRID (The "Bento" Tools) --- */
    .action-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }
    .action-grid.full { grid-template-columns: 1fr; }
    
    .btn-tool {
        background: var(--bg-button-secondary);
        border: none;
        border-radius: var(--radius-m);
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-main);
        font-size: 13px;
        font-weight: 600;
    }
    .btn-tool:active { transform: scale(0.97); }
    .btn-tool.danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); }
    .btn-tool.danger:active { background: rgba(255, 59, 48, 0.2); }
    
    /* --- MAIN BUTTON --- */
    .btn-primary {
        background: var(--text-main); /* Black in Light, White in Dark */
        color: var(--bg-body);
        width: 100%;
        padding: 18px;
        border-radius: var(--radius-l);
        border: none;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: var(--shadow-float);
        transition: transform 0.2s, opacity 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary:active { transform: scale(0.96); }

    /* --- ENTRIES --- */
    .entry-card {
        padding: 0;
        border: 1px solid var(--border);
    }
    .entry-header {
        padding: 16px 20px;
        background: var(--bg-surface);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
    }
    .entry-date { font-weight: 700; font-size: 15px; }
    .entry-content { padding: 20px; }
    .entry-text { font-size: 16px; line-height: 1.6; color: var(--text-main); white-space: pre-wrap; }
    .entry-label { 
        font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; 
        color: var(--text-secondary); margin-bottom: 4px; font-weight: 700; 
    }
    .entry-footer {
        padding: 12px 20px;
        display: flex; justify-content: flex-end; gap: 16px;
        border-top: 1px solid var(--border);
        background: rgba(128,128,128, 0.02);
    }
    .txt-btn {
        background: none; border: none; font-size: 14px; font-weight: 600; cursor: pointer;
    }

    /* --- POPOVER --- */
    .export-popover {
        position: absolute;
        bottom: 70px; left: 0; width: 100%;
        background: var(--bg-card);
        border-radius: var(--radius-l);
        padding: 8px;
        box-shadow: var(--shadow-float);
        display: none;
        flex-direction: column;
        z-index: 200;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid var(--border);
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .popover-item {
        background: transparent; border: none; padding: 14px; text-align: left;
        font-size: 16px; color: var(--text-main); border-radius: var(--radius-s);
        cursor: pointer; display: flex; align-items: center; gap: 10px;
    }
    .popover-item:hover { background: var(--bg-button-secondary); }

    /* --- TOAST --- */
    .toast {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100%);
        background: rgba(0,0,0,0.8); backdrop-filter: blur(12px); color: white;
        padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 14px;
        z-index: 9999; opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: var(--danger); }

    /* --- AUTH SCREEN --- */
    .auth-container { max-width: 400px; margin: 10vh auto; text-align: center; padding: 20px; }
    
    /* UTILS */
    .hidden { display: none !important; }
    .hidden-input { display: none; }
    
    /* SEARCH */
    .search-bar {
        background: var(--bg-button-secondary);
        border-radius: 12px;
        display: flex; align-items: center;
        padding: 0 12px;
        margin-bottom: 20px;
    }
    .search-input {
        background: transparent !important;
        box-shadow: none !important;
        padding: 12px 8px !important;
    }

  </style>
</head>
<body>

  <div id="toast" class="toast">Nachricht</div>

  <div id="authSection" class="auth-container">
    <div style="width:80px; height:80px; background:var(--text-main); border-radius:24px; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center; color:var(--bg-body); font-size:40px;">‚úíÔ∏è</div>
    <h1 style="font-size:32px; font-weight:800; margin-bottom:10px;">Journal</h1>
    <p style="color:var(--text-secondary); margin-bottom:40px;">Deine Gedanken. Sicher und sch√∂n.</p>
    
    <div class="card" style="padding:24px;">
      <label>E-Mail</label>
      <input type="email" id="authEmail" placeholder="hallo@beispiel.de" style="margin-bottom:16px;">
      <label>Passwort</label>
      <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      
      <div style="margin-top:24px; display:flex; flex-direction:column; gap:12px;">
        <button id="loginBtn" class="btn-primary">Anmelden</button>
        <button id="signupBtn" class="txt-btn" style="color:var(--text-secondary); margin-top:10px;">Account erstellen</button>
      </div>
    </div>
  </div>

  <div id="appSection" class="hidden">
    
    <div class="sticky-header-wrapper">
        <div class="topbar">
            <span class="app-title">Das Beste des Tages</span>
            <div style="display:flex; gap:12px;">
                <button id="themeToggle" class="theme-btn">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <button id="logoutBtn" class="txt-btn" style="color:var(--danger);">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
      
      <div id="reminderBox" class="card" style="background:rgba(255, 159, 10, 0.1); border:1px solid rgba(255, 159, 10, 0.2); padding:16px; display:none; flex-direction:row; align-items:center; justify-content:space-between;">
          <div style="color:#FF9F0A; font-weight:700; font-size:14px;">Backup empfohlen</div>
          <button id="remindExportBtn" style="background:#FF9F0A; color:white; border:none; padding:6px 12px; border-radius:20px; font-weight:600; font-size:12px; cursor:pointer;">Exportieren</button>
      </div>

      <div class="section-title">Neuer Eintrag</div>
      <div class="card" id="editorCard">
        
        <div style="padding:20px 20px 0 20px;">
            <div class="date-wrapper">
                <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span id="dateDisplay" class="date-display">Heute</span>
                <input type="date" id="entryDate">
            </div>
        </div>

        <div class="input-group">
            <label>Das Beste des Tages</label>
            <textarea id="bestOfDay" placeholder="Was was heute los?" rows="3"></textarea>
        </div>

        <div class="input-group" style="padding-top:0; display:flex; gap:12px;">
            <div style="flex:1;">
                <label>Lotta</label>
                <textarea id="lotta" rows="2"></textarea>
            </div>
            <div style="flex:1;">
                <label>Thea</label>
                <textarea id="thea" rows="2"></textarea>
            </div>
        </div>

        <div class="mood-container">
            <div class="mood-grid">
                <button class="mood-btn" data-mood="sad">üòû</button>
                <button class="mood-btn" data-mood="neutral">üòê</button>
                <button class="mood-btn" data-mood="happy">üôÇ</button>
            </div>
        </div>
        
        <div style="padding: 0 20px 24px 20px;">
            <button id="saveBtn" class="btn-primary">
                <span>Speichern</span>
            </button>
             <button id="cancelEditBtn" class="txt-btn hidden" style="width:100%; text-align:center; margin-top:16px; color:var(--text-secondary);">Abbrechen</button>
        </div>
      </div>

      <div class="section-title">Werkzeuge</div>
      <div class="action-grid" style="position:relative;">
          
          <button id="exportTriggerBtn" class="btn-tool">
              <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              Export
          </button>
          
          <label class="btn-tool" style="margin:0;">
              <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              Import
              <input type="file" id="importFile" accept=".csv,.xlsx" class="hidden-input">
          </label>

          <button id="deleteAllBtn" class="btn-tool danger" style="grid-column: span 2;">
              <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              Alle Eintr√§ge l√∂schen
          </button>

          <div id="exportPopover" class="export-popover">
            <button id="exportCsvBtn" class="popover-item">üìÑ CSV Datei</button>
            <button id="exportXlsxBtn" class="popover-item">üìä Excel Datei</button>
          </div>
      </div>

      <div class="section-title">Eintr√§ge</div>
      <div class="search-bar">
          <svg class="icon icon-sm" style="color:var(--text-secondary); margin-right:4px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" id="searchInput" class="search-input" placeholder="Suchen...">
      </div>
      
      <div style="display:none;">
          <input type="date" id="filterDateFrom">
          <input type="date" id="filterDateTo">
      </div>

      <div id="entriesContainer">
        </div>
    
    </div> </div> <script>
    console.log('üöÄ Journal 2025 Edition loaded.');
    
    // --- SUPABASE SETUP ---
    const SUPABASE_URL = 'https://gaosbiyccwawuzfjagvm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhb3NiaXljY3dhd3V6ZmphZ3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDYzODAsImV4cCI6MjA3ODY4MjM4MH0.s30-UTEY1xR3DP521ewc03aMRsG3WLH_I5VTi4_xu-4';
    
    const { createClient } = window.supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let selectedMood = null;
    let allEntriesCache = [];
    let currentEditingId = null;
    let fuse;

    const $ = id => document.getElementById(id);
    const elements = {
      authSection: $('authSection'),
      appSection: $('appSection'),
      email: $('authEmail'),
      password: $('authPassword'),
      entriesContainer: $('entriesContainer'),
      searchInput: $('searchInput'),
      filterDateFrom: $('filterDateFrom'),
      filterDateTo: $('filterDateTo'),
      themeToggle: $('themeToggle'),
      exportPopover: $('exportPopover'),
      saveBtn: $('saveBtn'),
      deleteAllBtn: $('deleteAllBtn'),
      cancelEditBtn: $('cancelEditBtn'),
      reminderBox: $('reminderBox'),
      dateDisplay: $('dateDisplay'),
      fields: {
        date: $('entryDate'),
        best: $('bestOfDay'),
        lotta: $('lotta'),
        thea: $('thea')
      }
    };

    function showToast(msg, isError = false) {
      const el = $('toast');
      el.textContent = msg;
      el.className = 'toast visible';
      if(isError) el.classList.add('error');
      else el.classList.remove('error');
      setTimeout(() => el.classList.remove('visible'), 3000);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
      }
    }
    elements.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // Date Picker UI Logic
    elements.fields.date.addEventListener('change', (e) => {
        const d = new Date(e.target.value);
        if(!isNaN(d.getTime())){
            elements.dateDisplay.textContent = d.toLocaleDateString('de-DE', { day:'numeric', month:'long', year:'numeric' });
        }
    });

    // Auto Resize Textarea
    function autoResize(textarea) {
      textarea.style.height = 'auto'; 
      textarea.style.height = textarea.scrollHeight + 'px'; 
    }
    ['best', 'lotta', 'thea'].forEach(id => {
      const el = elements.fields[id];
      el.addEventListener('input', () => autoResize(el));
      setTimeout(() => autoResize(el), 50);
    });

    // --- AUTH ---
    db.auth.getSession().then(({ data: { session } }) => {
      if (session) showApp(session.user);
      else showAuth();
    });

    db.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) showApp(session.user);
      else if (event === 'SIGNED_OUT') showAuth();
    });

    function showAuth() {
      elements.authSection.classList.remove('hidden');
      elements.appSection.classList.add('hidden');
      currentUser = null;
    }

    function showApp(user) {
      currentUser = user;
      elements.authSection.classList.add('hidden');
      elements.appSection.classList.remove('hidden');
      resetEditor();
      loadEntries();
      checkMonthlyReminder();
    }

    $('loginBtn').addEventListener('click', async () => {
      showToast('Anmelden...');
      const { error } = await db.auth.signInWithPassword({
        email: elements.email.value.trim(),
        password: elements.password.value
      });
      if (error) showToast('Fehler: ' + error.message, true);
    });

    $('signupBtn').addEventListener('click', async () => {
      showToast('Account wird erstellt...');
      const { error } = await db.auth.signUp({
        email: elements.email.value.trim(),
        password: elements.password.value
      });
      if (error) showToast(error ? error.message : 'Check deine Mails!', !!error);
    });

    $('logoutBtn').addEventListener('click', () => db.auth.signOut());

    // --- REMINDER ---
    function checkMonthlyReminder() {
        const last = localStorage.getItem('last_dismissed_export_month');
        const curr = new Date().toISOString().slice(0, 7); 
        if (last !== curr) elements.reminderBox.style.display = 'flex';
        else elements.reminderBox.style.display = 'none';
    }
    $('remindExportBtn').addEventListener('click', () => { exportData('xlsx'); });
    function dismissReminder() {
        localStorage.setItem('last_dismissed_export_month', new Date().toISOString().slice(0, 7));
        elements.reminderBox.style.display = 'none';
    }

    // --- EDITOR LOGIC ---
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    function resetEditor() {
        currentEditingId = null;
        elements.saveBtn.innerHTML = "<span>Speichern</span>";
        elements.cancelEditBtn.classList.add('hidden');
        
        const today = new Date().toISOString().split('T')[0];
        elements.fields.date.value = today;
        elements.dateDisplay.textContent = "Heute";
        
        elements.fields.best.value = '';
        elements.fields.lotta.value = '';
        elements.fields.thea.value = '';
        selectedMood = null;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        ['best', 'lotta', 'thea'].forEach(id => { elements.fields[id].style.height = 'auto'; });
    }

    function startEdit(entry) {
        currentEditingId = entry.id;
        elements.saveBtn.innerHTML = "<span>Update speichern</span>";
        elements.cancelEditBtn.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        elements.fields.date.value = entry.entry_date;
        const d = new Date(entry.entry_date);
        elements.dateDisplay.textContent = d.toLocaleDateString('de-DE', { day:'numeric', month:'long', year:'numeric' });

        elements.fields.best.value = entry.best_of_day || '';
        elements.fields.lotta.value = entry.lotta || '';
        elements.fields.thea.value = entry.thea || '';
        selectedMood = entry.mood;
        document.querySelectorAll('.mood-btn').forEach(b => {
            if (b.dataset.mood === entry.mood) b.classList.add('selected');
            else b.classList.remove('selected');
        });
        ['best', 'lotta', 'thea'].forEach(id => autoResize(elements.fields[id]));
    }
    elements.cancelEditBtn.addEventListener('click', resetEditor);

    // --- SAVE ---
    elements.saveBtn.addEventListener('click', async () => {
      if (!selectedMood) return showToast('Wie war die Stimmung? ü§î', true);
      if (!currentUser) return showToast('Nicht eingeloggt.', true);

      elements.saveBtn.disabled = true;
      elements.saveBtn.innerHTML = "<span>Moment...</span>";

      const entryData = {
        user_id: currentUser.id,
        entry_date: elements.fields.date.value,
        best_of_day: elements.fields.best.value?.trim() || null,
        lotta: elements.fields.lotta.value?.trim() || null,
        thea: elements.fields.thea.value?.trim() || null,
        mood: selectedMood
      };

      try {
          const { error } = currentEditingId 
            ? await db.from('entries').update(entryData).eq('id', currentEditingId)
            : await db.from('entries').insert(entryData);
          
          if (error) throw error;
          showToast(currentEditingId ? 'Eintrag aktualisiert ‚ú®' : 'Gespeichert ‚úÖ');
          resetEditor();
          await loadEntries();
      } catch(err) {
          showToast('Fehler: ' + err.message, true);
      } finally {
          elements.saveBtn.disabled = false;
          elements.saveBtn.innerHTML = "<span>Speichern</span>";
      }
    });

    // --- LOAD & RENDER ---
    async function loadEntries() {
      elements.entriesContainer.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">Lade...</div>';
      const { data, error } = await db.from('entries').select('*').order('entry_date', { ascending: false }).limit(2000);

      if (error) return showToast('Ladefehler: ' + error.message, true);
      allEntriesCache = data || [];
      fuse = new Fuse(allEntriesCache, { includeScore: true, threshold: 0.4, keys: ['best_of_day', 'lotta', 'thea', 'entry_date'] });
      renderFilteredEntries();
    }

    function renderFilteredEntries() {
        const term = elements.searchInput.value.toLowerCase().trim();
        let filtered = allEntriesCache;
        if (term.length > 0) {
            filtered = fuse.search(term).map(r => r.item);
        }
        renderDOM(filtered);
    }
    elements.searchInput.addEventListener('input', renderFilteredEntries);

    function renderDOM(entries) {
      if (!entries.length) {
        elements.entriesContainer.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:var(--text-secondary);">
                <div style="font-size:40px; margin-bottom:10px; opacity:0.3;">üì≠</div>
                Keine Eintr√§ge gefunden.
            </div>`;
        return;
      }
      elements.entriesContainer.innerHTML = entries.map(entry => {
        const moodMap = { 'happy': 'üôÇ', 'neutral': 'üòê', 'sad': 'üòû' };
        const d = new Date(entry.entry_date);
        const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' });

        return `
          <div class="card entry-card">
            <div class="entry-header">
              <span class="entry-date">${dateStr}</span>
              <span style="font-size:20px;">${moodMap[entry.mood] || ''}</span>
            </div>
            <div class="entry-content">
              ${entry.best_of_day ? `<div style="margin-bottom:20px;"><div class="entry-text">${escapeHtml(entry.best_of_day)}</div></div>` : ''}
              
              <div style="display:flex; gap:20px; flex-wrap:wrap;">
                  ${entry.lotta ? `<div style="flex:1; min-width:120px;"><div class="entry-label">Lotta</div><div class="entry-text" style="font-size:15px;">${escapeHtml(entry.lotta)}</div></div>` : ''}
                  ${entry.thea ? `<div style="flex:1; min-width:120px;"><div class="entry-label">Thea</div><div class="entry-text" style="font-size:15px;">${escapeHtml(entry.thea)}</div></div>` : ''}
              </div>
            </div>
            <div class="entry-footer">
                <button class="txt-btn" style="color:var(--accent);" onclick="window.editEntry('${entry.id}')">Bearbeiten</button>
                <button class="txt-btn" style="color:var(--danger);" onclick="window.deleteEntry('${entry.id}')">L√∂schen</button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.editEntry = (id) => {
        const e = allEntriesCache.find(x => x.id === id);
        if (e) startEdit(e);
    };

    window.deleteEntry = async (id) => {
      if (!confirm('Eintrag wirklich l√∂schen?')) return; 
      const { error } = await db.from('entries').delete().eq('id', id);
      if (error) showToast(error.message, true);
      else {
        showToast('Gel√∂scht.');
        allEntriesCache = allEntriesCache.filter(e => e.id !== id);
        fuse.setCollection(allEntriesCache);
        renderFilteredEntries();
      }
    };

    // --- TOOLS ---
    elements.deleteAllBtn.addEventListener('click', async () => {
        if (!confirm('üö® Wirklich ALLES unwiderruflich l√∂schen?')) return;
        const { error } = await db.from('entries').delete().eq('user_id', currentUser.id);
        if (error) showToast(error.message, true);
        else { showToast('Bereinigt.'); loadEntries(); }
    });

    const popover = elements.exportPopover;
    const trigger = $('exportTriggerBtn');
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const show = popover.style.display === 'flex';
      popover.style.display = show ? 'none' : 'flex';
    });
    document.addEventListener('click', (e) => {
      if (!trigger.contains(e.target) && !popover.contains(e.target)) popover.style.display = 'none';
    });

    $('exportCsvBtn').addEventListener('click', () => { popover.style.display='none'; exportData('csv'); });
    $('exportXlsxBtn').addEventListener('click', () => { popover.style.display='none'; exportData('xlsx'); });

    async function exportData(type) {
      showToast('Exportiere...');
      const data = allEntriesCache.map(r => ({
          entry_date: r.entry_date,
          best_of_day: r.best_of_day,
          lotta: r.lotta,
          thea: r.thea,
          mood: r.mood
      }));
      const fname = `Journal_Export_${new Date().toISOString().slice(0,10)}.${type}`;
      
      if (type === 'csv') {
        const headers = ['entry_date', 'best_of_day', 'lotta', 'thea', 'mood'];
        const csv = [headers.join(','), ...data.map(row => headers.map(h => `"${String(row[h]||'').replace(/"/g,'""')}"`).join(','))].join('\n');
        downloadBlob(csv, fname, 'text/csv;charset=utf-8;');
      } else {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Journal");
        XLSX.writeFile(wb, fname);
      }
      showToast('Erledigt! üìÇ');
      dismissReminder();
    }

    function normalizeDate(val) {
        if (!val) return null;
        const n = Number(val);
        if (typeof XLSX!=='undefined' && !isNaN(n) && n>20000 && n<70000) { 
             try { return XLSX.utils.numberToDate(n).toISOString().split('T')[0]; } catch(e){}
        }
        const s = String(val).trim();
        if (s.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
            const p = s.split('.');
            return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
        }
        const d = new Date(s);
        return !isNaN(d.getTime()) ? d.toISOString().split('T')[0] : null;
    }
    
    $('importFile').addEventListener('change', async (e) => {
        if (!currentUser) return showToast('Login erforderlich', true);
        const f = e.target.files[0];
        if (!f) return;
        showToast('Verarbeite...');
        try {
            let rows;
            if (f.name.endsWith('.csv')) {
                 const text = await f.text();
                 // Simple CSV parser
                 const lines = text.split('\n').filter(l=>l.trim());
                 const h = lines[0].split(',').map(x=>x.trim().replace(/^"|"$/g,'').toLowerCase());
                 rows = lines.slice(1).map(l=>{
                     const o={}; let inQ=false, val='', c=0;
                     for(let i=0;i<l.length;i++){
                         if(l[i]==='"'){ if(inQ && l[i+1]==='"'){val+='"';i++}else inQ=!inQ; }
                         else if(l[i]===',' && !inQ){ if(c<h.length)o[h[c]]=val; val=''; c++; }
                         else val+=l[i];
                     }
                     if(c<h.length)o[h[c]]=val;
                     return o;
                 });
            } else {
                const wb = XLSX.read(await f.arrayBuffer(), { type: 'array' });
                rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false });
            }
            const clean = rows.map(r => {
                let m = String(r.mood||'').toLowerCase().trim();
                if(['1','sad'].includes(m)) m='sad';
                else if(['3','happy'].includes(m)) m='happy';
                else m='neutral';
                
                const d = normalizeDate(r.entry_date);
                const b = String(r.best_of_day||'').trim() || null;
                const l = String(r.lotta||'').trim() || null;
                const t = String(r.thea||'').trim() || null;
                return { user_id: currentUser.id, entry_date: d, best_of_day: b, lotta: l, thea: t, mood: m, _v: !!(d&&(b||l||t)) };
            }).filter(x => x._v).map(x => { delete x._v; return x; });

            if (!clean.length) return showToast('Keine Daten erkannt', true);
            const { error } = await db.from('entries').insert(clean);
            if (error) throw error;
            showToast(`${clean.length} importiert!`);
            loadEntries();
        } catch(err) { showToast('Fehler: '+err.message, true); }
        $('importFile').value = '';
    });

    function escapeHtml(t) { return (t||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
    function downloadBlob(c, n, m) {
      const u = URL.createObjectURL(new Blob([c], {type:m}));
      const a = document.createElement('a'); a.href=u; a.download=n; a.click();
      URL.revokeObjectURL(u);
    }

    initTheme();
</script>
</body>
</html>
