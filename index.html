<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>das-beste-des-tages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; background:#f9f9f9; color:#111; }
    .dark { background:#111; color:#f9f9f9; }
    .container { max-width:600px; margin:0 auto; padding:20px; }
    h1 { text-align:center; }
    textarea { width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc; resize:none; }
    input[type=date] { padding:8px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px; width:100%; }
    button { padding:10px 15px; margin:5px 0; border:none; border-radius:8px; cursor:pointer; }
    .mood-btn { width:32%; display:inline-block; text-align:center; font-size:24px; padding:10px 0; border:2px solid #ccc; border-radius:8px; }
    .selected { border-color:#007bff; background:#cce5ff; }
    .entry { border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:10px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>das-beste-des-tages</h1>
      <button id="toggleDark">ğŸŒ™</button>
    </div>

    <div>
      <input type="date" id="entryDate">
      <textarea id="field1" rows="2" placeholder="Was ist passiert?"></textarea>
      <textarea id="field2" rows="2" placeholder="Was habe ich gelernt?"></textarea>
      <textarea id="field3" rows="2" placeholder="WofÃ¼r bin ich dankbar?"></textarea>
      <div>
        <button class="mood-btn" data-value="1">ğŸ˜</button>
        <button class="mood-btn" data-value="2">ğŸ˜</button>
        <button class="mood-btn" data-value="3">ğŸ™‚</button>
      </div>
      <button id="saveEntry">Eintrag speichern</button>
      <button id="exportCsv">Export CSV</button>
      <input type="file" id="importCsv">
    </div>

    <h2>Meine EintrÃ¤ge</h2>
    <div id="entriesList"></div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://github.com/Daiti50552531/das-beste-des-tages.git';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Ynhqbm94cHp2aXVpaXdiY2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0OTc4MzIsImV4cCI6MjA3ODA3MzgzMn0.D5kFuUTHfVg92m1zzDNj9-PXaQzivm9uO1hNZyk6PAE';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elemente
    const entryDate = document.getElementById('entryDate');
    const field1 = document.getElementById('field1');
    const field2 = document.getElementById('field2');
    const field3 = document.getElementById('field3');
    const moodButtons = document.querySelectorAll('.mood-btn');
    const saveBtn = document.getElementById('saveEntry');
    const entriesList = document.getElementById('entriesList');
    const toggleDark = document.getElementById('toggleDark');
    const exportCsvBtn = document.getElementById('exportCsv');
    const importCsvInput = document.getElementById('importCsv');

    let selectedMood = null;

    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedMood = parseInt(btn.dataset.value);
        moodButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });

    toggleDark.addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    async function fetchEntries() {
      const { data, error } = await supabase.from('entries').select('*').order('date', { ascending:false });
      if (error) { console.error(error); return; }
      renderEntries(data);
    }

    function renderEntries(entries) {
      entriesList.innerHTML = '';
      entries.forEach(e => {
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `<strong>${new Date(e.date).toLocaleDateString('de-DE')}</strong> <br>
          ğŸ˜ğŸ˜ğŸ™‚: ${['','ğŸ˜','ğŸ˜','ğŸ™‚'][e.mood]} <br>
          ${e.text1 ? e.text1+'<br>':''}${e.text2 ? e.text2+'<br>':''}${e.text3 ? e.text3:''}`;
        entriesList.appendChild(div);
      });
    }

    saveBtn.addEventListener('click', async () => {
      if (!entryDate.value || !selectedMood) {
        alert('Datum und Stimmung bitte auswÃ¤hlen');
        return;
      }
      const { data, error } = await supabase.from('entries').upsert([{
        date: entryDate.value,
        text1: field1.value,
        text2: field2.value,
        text3: field3.value,
        mood: selectedMood
      }]);
      if (error) { console.error(error); return; }
      field1.value = field2.value = field3.value = '';
      selectedMood = null;
      moodButtons.forEach(b => b.classList.remove('selected'));
      fetchEntries();
    });

    exportCsvBtn.addEventListener('click', async () => {
      const { data } = await supabase.from('entries').select('*');
      const csv = ['Datum,Text1,Text2,Text3,Mood', ...data.map(e => `${e.date},"${e.text1}","${e.text2}","${e.text3}",${e.mood}`)].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tagebuch.csv';
      a.click();
    });

    importCsvInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const lines = text.split('\n').slice(1);
      for (const line of lines) {
        const [date, t1, t2, t3, mood] = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g,''));
        await supabase.from('entries').upsert([{ date, text1:t1, text2:t2, text3:t3, mood:parseInt(mood) }]);
      }
      fetchEntries();
    });

    entryDate.value = new Date().toISOString().split('T')[0];
    fetchEntries();
  </script>
</body>
</html>
