<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Das Beste des Tages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Supabase Setup (neu) -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://htbxinoxpzviujiwbctv.supabase.co"; // deine echte URL hier
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Ynhqbm94cHp2aXVpaXdiY2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0OTc4MzIsImV4cCI6MjA3ODA3MzgzMn0.D5kFuUTHfVg92m1zzDNj9-PXaQzivm9uO1hNZyk6PAE"; // dein echter Anon-Key hier

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabase; // global verf√ºgbar machen
  </script>

  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      margin:0; padding:0; 
      background:#f9f9f9; 
      color:#111; 
      transition: background 0.3s, color 0.3s;
    }
    .dark { background:#111; color:#f9f9f9; }
    .container { max-width:600px; margin:0 auto; padding:20px; }
    h1 { text-align:center; margin-bottom:20px; font-size:1.8em; }
    textarea, input[type=date] { 
      width:100%; padding:10px; margin-bottom:10px; 
      border-radius:10px; border:1px solid #ccc; 
      font-size:1em; box-sizing:border-box; 
      background:white; 
    }
    .dark textarea, .dark input[type=date] {
      background:#222; border-color:#444; color:white;
    }
    button { 
      padding:10px 15px; margin:5px 0; 
      border:none; border-radius:10px; 
      cursor:pointer; font-size:1em; 
      background:#007aff; color:white; 
      transition: all 0.2s;
    }
    button:hover { background:#0061d0; }
    .mood-btn { 
      width:32%; display:inline-block; text-align:center; 
      font-size:28px; padding:10px 0; 
      border:2px solid #ccc; border-radius:10px; 
      background:white; cursor:pointer;
    }
    .mood-btn.selected { border-color:#007aff; background:#e7f0ff; }
    .dark .mood-btn { background:#222; border-color:#444; color:white; }
    .dark .mood-btn.selected { background:#004fc5; border-color:#007aff; }
    .entry { 
      border:1px solid #ddd; border-radius:10px; 
      padding:12px; margin-bottom:10px; 
      background:white;
    }
    .dark .entry { background:#1e1e1e; border-color:#444; }
    .topbar { 
      display:flex; justify-content:space-between; align-items:center; 
      margin-bottom:20px;
    }
    #entriesList { margin-top:20px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Das Beste des Tages</h1>
      <button id="toggleDark">üåô</button>
    </div>

    <div>
      <input type="date" id="entryDate">
      <textarea id="field1" rows="2" placeholder="Das Beste des Tages"></textarea>
      <textarea id="field2" rows="2" placeholder="Lotta"></textarea>
      <textarea id="field3" rows="2" placeholder="Thea"></textarea>

      <div>
        <button class="mood-btn" data-value="1">üòû</button>
        <button class="mood-btn" data-value="2">üòê</button>
        <button class="mood-btn" data-value="3">üôÇ</button>
      </div>

      <button id="saveEntry">Eintrag speichern</button>
      <button id="exportCsv">Export CSV</button>
      <input type="file" id="importCsv">
    </div>

    <h2>Meine Eintr√§ge</h2>
    <div id="entriesList"></div>
  </div>

  <script>
    const supabase = window.supabaseClient; // <--- neu, damit es sicher existiert

    // Elemente referenzieren
    const entryDate = document.getElementById('entryDate');
    const field1 = document.getElementById('field1');
    const field2 = document.getElementById('field2');
    const field3 = document.getElementById('field3');
    const moodButtons = document.querySelectorAll('.mood-btn');
    const saveBtn = document.getElementById('saveEntry');
    const entriesList = document.getElementById('entriesList');
    const toggleDark = document.getElementById('toggleDark');
    const exportCsvBtn = document.getElementById('exportCsv');
    const importCsvInput = document.getElementById('importCsv');

    let selectedMood = null;

    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedMood = parseInt(btn.dataset.value);
        moodButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });

    toggleDark.addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    async function fetchEntries() {
      const { data, error } = await supabase.from('entries').select('*').order('date', { ascending:false });
      if (error) { console.error(error); return; }
      renderEntries(data);
    }

    function renderEntries(entries) {
      entriesList.innerHTML = '';
      entries.forEach(e => {
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `<strong>${new Date(e.date).toLocaleDateString('de-DE')}</strong><br>
          Stimmung: ${['','üòû','üòê','üôÇ'][e.mood]}<br>
          ${e.text1 ? e.text1+'<br>':''}${e.text2 ? e.text2+'<br>':''}${e.text3 ? e.text3:''}`;
        entriesList.appendChild(div);
      });
    }

    saveBtn.addEventListener('click', async () => {
      if (!entryDate.value || !selectedMood) {
        alert('Datum und Stimmung bitte ausw√§hlen');
        return;
      }
      const { error } = await supabase.from('entries').upsert([{
        date: entryDate.value,
        text1: field1.value,
        text2: field2.value,
        text3: field3.value,
        mood: selectedMood
      }]);
      if (error) { console.error(error); return; }
      field1.value = field2.value = field3.value = '';
      selectedMood = null;
      moodButtons.forEach(b => b.classList.remove('selected'));
      fetchEntries();
    });

    exportCsvBtn.addEventListener('click', async () => {
      const { data } = await supabase.from('entries').select('*');
      const csv = ['Datum,Text1,Text2,Text3,Mood', ...data.map(e => `${e.date},"${e.text1}","${e.text2}","${e.text3}",${e.mood}`)].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tagebuch.csv';
      a.click();
    });

    importCsvInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const lines = text.split('\n').slice(1); // erste Zeile (√úberschrift) √ºberspringen
      for (const line of lines) {
        if (!line.trim()) continue;
        const [date, t1, t2, t3, mood] = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g,''));
        await supabase.from('entries').upsert([{ date, text1:t1, text2:t2, text3:t3, mood:parseInt(mood) }]);
      }
      fetchEntries();
    });

    entryDate.value = new Date().toISOString().split('T')[0];
    fetchEntries();
  </script>
</body>
</html>
