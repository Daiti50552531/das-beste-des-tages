<!Doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Mein Journal</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

  <style>
    :root {
      /* APPLE IOS PALETTE - REFINED */
      --primary: #34C759; /* Apple Green */
      --primary-gradient: linear-gradient(135deg, #34C759, #30D158);
      --primary-shadow: rgba(52, 199, 89, 0.4);
      
      --bg-body: #000000; /* Deep Black */
      --bg-card: #1C1C1E; /* Secondary System Grouped Background */
      --bg-input: #2C2C2E; /* Tertiary System Grouped Background */
      
      --separator: rgba(84, 84, 88, 0.65); /* Separator Line */
      
      --text-main: #FFFFFF;
      --text-secondary: #8E8E93; /* System Gray */
      --text-tertiary: #48484A;
      
      --danger: #FF453A;
      --accent: #0A84FF;
      
      --radius-l: 22px;
      --radius-m: 14px;
      --radius-s: 10px;
      
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      
      --glass: rgba(28, 28, 30, 0.85);
      --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.5);
    }

    .light-mode {
      --primary: #28CD41; /* Slightly darker for contrast on white */
      --primary-gradient: linear-gradient(135deg, #34C759, #28CD41);
      --primary-shadow: rgba(40, 205, 65, 0.3);
      
      --bg-body: #F2F2F7; /* iOS System Gray 6 (Grouped Background) */
      --bg-card: #FFFFFF;
      --bg-input: #F2F2F7; /* Slightly distinct from white card */
      
      --separator: rgba(60, 60, 67, 0.12); /* Light separator */
      
      --text-main: #000000;
      --text-secondary: #8E8E93;
      --text-tertiary: #C7C7CC;
      
      --danger: #FF3B30;
      --accent: #007AFF;
      
      --glass: rgba(255, 255, 255, 0.8);
      --shadow-soft: 0 8px 30px -6px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding-top: 80px; /* Space for Header */
      padding-bottom: 60px;
      min-height: 100vh;
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }
    
    /* --- TYPOGRAPHY --- */
    h1, h2, h3 { margin: 0; letter-spacing: -0.02em; }
    
    /* --- HEADER (Glassmorphism) --- */
    .sticky-header-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 100;
        background: var(--glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 0.5px solid var(--separator);
    }
    .topbar {
        max-width: 680px;
        margin: 0 auto;
        padding: 14px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .app-title {
        font-size: 22px;
        font-weight: 700; 
        color: var(--text-main);
    }
    
    .header-btn {
        background: transparent;
        border: none;
        color: var(--accent);
        font-size: 16px;
        font-weight: 400;
        cursor: pointer;
        padding: 8px;
        transition: opacity 0.2s;
    }
    .header-btn:hover { opacity: 0.7; }
    .icon-only { font-size: 20px; color: var(--text-main); }

    /* --- LAYOUT --- */
    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* --- CARD DESIGN --- */
    .card {
      background: var(--bg-card);
      padding: 28px;
      border-radius: var(--radius-l);
      box-shadow: var(--shadow-soft);
      margin-bottom: 30px;
      border: 0.5px solid rgba(0,0,0,0.02); /* Ultra subtle border */
    }

    /* --- INPUTS & LABELS --- */
    label {
      display: block;
      margin-top: 24px;
      margin-bottom: 10px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }
    
    /* Input Reset & Styling */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: var(--radius-m);
      background: var(--bg-input);
      color: var(--text-main);
      font-family: var(--font-stack);
      font-size: 17px;
      font-weight: 400;
      transition: all 0.3s ease;
      -webkit-appearance: none; /* Remove iOS default styles */
    }
    
    textarea {
      min-height: 120px;
      resize: none;
      line-height: 1.5;
    }

    input:focus, textarea:focus {
      outline: none;
      background: var(--bg-card); /* White on focus if light mode */
      box-shadow: 0 0 0 2px var(--primary); 
    }
    
    /* Special Date Input Styling */
    #entryDate {
        font-size: 20px;
        font-weight: 600;
        text-align: center;
        background: transparent;
        color: var(--accent);
        padding: 5px;
        cursor: pointer;
        margin-bottom: 10px;
    }

    /* --- MOOD SELECTOR --- */
    .mood-section {
      text-align: center;
      margin: 35px 0 25px 0;
    }
    .mood-buttons {
      display: inline-flex;
      background: var(--bg-input);
      border-radius: 100px;
      padding: 4px;
      gap: 0;
    }
    .mood-btn {
      font-size: 28px;
      width: 60px;
      height: 50px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      filter: grayscale(100%);
      opacity: 0.6;
    }
    .mood-btn:hover { opacity: 1; filter: grayscale(0%); }
    .mood-btn.selected {
      background: var(--bg-card);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      filter: grayscale(0%);
      opacity: 1;
      transform: scale(1.05);
    }

    /* --- BUTTONS --- */
    .save-btn-wrapper { margin-top: 30px; }
    
    .btn-hero {
      width: 100%;
      padding: 18px;
      border-radius: var(--radius-m);
      border: none;
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.01em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      background: var(--primary-gradient);
      box-shadow: 0 10px 25px -5px var(--primary-shadow);
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }
    .btn-hero:active { transform: scale(0.97); opacity: 0.9; }
    .btn-hero:hover { box-shadow: 0 14px 30px -8px var(--primary-shadow); }
    .btn-hero span { position: relative; z-index: 2; }

    /* Secondary Toolbar (Import/Export/Delete) */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 0.5px solid var(--separator);
    }
    .toolbar-group { display: flex; gap: 15px; }
    
    .btn-text {
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px 0;
        transition: color 0.2s;
    }
    .btn-text:hover { color: var(--text-main); }
    .btn-text.danger { color: var(--danger); opacity: 0.8; }
    .btn-text.danger:hover { opacity: 1; }

    .hidden-input { display: none; }

    /* --- ENTRIES LIST --- */
    .entries-grid { display: flex; flex-direction: column; gap: 20px; }
    
    .entry-card {
      background: var(--bg-card);
      padding: 0; /* Content padding handled inside */
      border-radius: var(--radius-l);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      position: relative;
    }
    
    .entry-header {
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(128,128,128, 0.03);
      border-bottom: 0.5px solid var(--separator);
    }
    
    .entry-date { 
        font-size: 15px; 
        font-weight: 700; 
        color: var(--text-main); 
        letter-spacing: -0.01em;
    }
    .entry-mood { font-size: 22px; }
    
    .entry-content { padding: 24px; }
    .entry-block { margin-bottom: 24px; }
    .entry-block:last-child { margin-bottom: 0; }

    .label-text {
        font-size: 11px;
        color: var(--text-secondary);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    }
    
    .entry-text {
        font-size: 17px;
        line-height: 1.6;
        color: var(--text-main);
        white-space: pre-wrap; 
        font-weight: 400;
    }
    
    .entry-footer {
        padding: 12px 24px;
        border-top: 0.5px solid var(--separator);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    .action-link {
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        padding: 5px;
    }
    .edit-link { color: var(--accent); }
    .delete-link { color: var(--danger); }

    /* Export Popover */
    .export-popover {
      position: absolute;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 200;
      display: none;
      flex-direction: column;
      width: 180px;
      bottom: 60px; 
      left: 20px; /* Align with left button */
      overflow: hidden;
      padding: 5px;
    }
    .export-popover button {
      background: transparent;
      color: var(--text-main);
      text-align: left;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 14px;
      border: none;
      cursor: pointer;
    }
    .export-popover button:hover { background: var(--bg-input); }

    /* Reminder Box */
    .reminder-box {
        background: linear-gradient(135deg, rgba(255, 159, 10, 0.1), rgba(255, 159, 10, 0.05));
        border: 1px solid rgba(255, 159, 10, 0.3);
        padding: 16px 20px;
        border-radius: var(--radius-m);
        margin-bottom: 30px;
        display: none; 
        align-items: center;
        justify-content: space-between;
    }
    .reminder-text { color: #FF9F0A; font-weight: 600; font-size: 14px; }
    .reminder-btn { 
        font-size: 12px; font-weight: 600; padding: 6px 12px; 
        background: #FF9F0A; color: white; border-radius: 20px; border:none; cursor: pointer;
    }

    .hidden { display: none !important; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(50, 50, 50, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 500;
      font-size: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.error { background: var(--danger); }

    /* Auth Screen */
    .auth-container {
      max-width: 380px;
      margin: 15vh auto;
      text-align: center;
      padding: 0 20px;
    }
    
    /* Search Bar Wrapper */
    .search-wrapper {
        margin-bottom: 25px;
    }
    #searchInput {
        background: var(--bg-card);
        padding-left: 40px; /* Space for icon */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238E8E93' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: 12px center;
    }

    .date-filters {
        display: flex; gap: 10px; margin-bottom: 10px;
    }
    .date-filters input { font-size: 14px; padding: 10px; }

  </style>
</head>
<body>

  <div id="toast" class="toast">Nachricht</div>

  <div id="authSection" class="auth-container">
    <div style="font-size:50px; margin-bottom:10px;">üìî</div>
    <h1 style="margin-bottom:10px; font-weight:800; font-size: 34px; letter-spacing:-1px;">Journal</h1>
    <p style="color:var(--text-secondary); margin-bottom:40px; font-size:17px;">Melde dich an, um fortzufahren.</p>
    
    <div class="card" style="text-align:left;">
      <label>E-Mail Adresse</label>
      <input type="email" id="authEmail" placeholder="name@icloud.com">
      
      <label>Passwort</label>
      <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      
      <div style="margin-top:30px; display:flex; flex-direction:column; gap:15px;">
        <button id="loginBtn" class="btn-hero">Anmelden</button>
        <button id="signupBtn" class="btn-text" style="width:100%; text-align:center;">Account erstellen</button>
      </div>
    </div>
  </div>

  <div id="appSection" class="hidden">
    
    <div class="sticky-header-wrapper">
        <div class="topbar">
            <span class="app-title">Journal</span>
            <div style="display:flex; gap:10px;">
              <button id="themeToggle" class="header-btn icon-only" title="Design umschalten">‚óë</button>
              <button id="logoutBtn" class="header-btn">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
      
      <div id="reminderBox" class="reminder-box">
          <div class="reminder-text">Backup f√§llig!</div>
          <button id="remindExportBtn" class="reminder-btn">Excel Export</button>
      </div>

      <div class="card" id="editorCard">
        <div style="text-align:center;">
             <input type="date" id="entryDate">
        </div>

        <label>Das Beste des Tages</label>
        <textarea id="bestOfDay" placeholder="Was war heute besonders sch√∂n?"></textarea>

        <div style="display:flex; gap:20px;">
            <div style="flex:1;">
                <label>Lotta</label>
                <textarea id="lotta" placeholder="..."></textarea>
            </div>
            <div style="flex:1;">
                <label>Thea</label>
                <textarea id="thea" placeholder="..."></textarea>
            </div>
        </div>

        <div class="mood-section">
          <div class="mood-buttons">
            <button class="mood-btn" data-mood="sad">üòû</button>
            <button class="mood-btn" data-mood="neutral">üòê</button>
            <button class="mood-btn" data-mood="happy">üôÇ</button>
          </div>
        </div>

        <div class="save-btn-wrapper">
            <button id="saveBtn" class="btn-hero">
                <span>Speichern</span>
            </button>
            <button id="cancelEditBtn" class="btn-text hidden" style="width:100%; margin-top:15px; text-align:center;">
                Abbrechen
            </button>
        </div>

        <div class="toolbar" style="position: relative;">
          <div class="toolbar-group">
              <button id="exportTriggerBtn" class="btn-text">
                 Exportieren ‚ñæ
              </button>
              <label class="btn-text">
                 Importieren
                 <input type="file" id="importFile" accept=".csv,.xlsx" class="hidden-input">
              </label>
          </div>
          
          <button id="deleteAllBtn" class="btn-text danger">
             Alle L√∂schen
          </button>

          <div id="exportPopover" class="export-popover">
            <button id="exportCsvBtn">Als CSV</button>
            <button id="exportXlsxBtn">Als Excel</button>
          </div>
        </div>
      </div>

      <div class="search-wrapper">
         <div class="date-filters hidden" id="dateFilters"> <input type="date" id="filterDateFrom">
             <input type="date" id="filterDateTo">
         </div>
         <input type="text" id="searchInput" placeholder="In Eintr√§gen suchen...">
         <div style="display:flex; gap:10px; margin-top:10px;">
             <input type="date" id="filterDateFrom" style="font-size:13px; padding:10px;">
             <input type="date" id="filterDateTo" style="font-size:13px; padding:10px;">
         </div>
      </div>

      <div id="entriesContainer" class="entries-grid">
        </div>
    
    </div> </div> <script>
    console.log('üöÄ App startet im Premium Apple Design...');
    
    // --- KONFIGURATION ---
    const SUPABASE_URL = 'https://gaosbiyccwawuzfjagvm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhb3NiaXljY3dhd3V6ZmphZ3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDYzODAsImV4cCI6MjA3ODY4MjM4MH0.s30-UTEY1xR3DP521ewc03aMRsG3WLH_I5VTi4_xu-4';
    
    const { createClient } = window.supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let selectedMood = null;
    let allEntriesCache = [];
    let currentEditingId = null;
    let fuse;

    const $ = id => document.getElementById(id);
    const elements = {
      authSection: $('authSection'),
      appSection: $('appSection'),
      email: $('authEmail'),
      password: $('authPassword'),
      entriesContainer: $('entriesContainer'),
      searchInput: $('searchInput'),
      filterDateFrom: $('filterDateFrom'),
      filterDateTo: $('filterDateTo'),
      themeToggle: $('themeToggle'),
      exportPopover: $('exportPopover'),
      saveBtn: $('saveBtn'),
      deleteAllBtn: $('deleteAllBtn'),
      cancelEditBtn: $('cancelEditBtn'),
      reminderBox: $('reminderBox'),
      fields: {
        date: $('entryDate'),
        best: $('bestOfDay'),
        lotta: $('lotta'),
        thea: $('thea')
      }
    };

    function showToast(msg, isError = false) {
      const el = $('toast');
      el.textContent = msg;
      el.className = 'toast visible';
      if(isError) el.classList.add('error');
      else el.classList.remove('error');
      setTimeout(() => el.classList.remove('visible'), 3000);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
      }
    }
    elements.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    function autoResize(textarea) {
      textarea.style.height = 'auto'; 
      textarea.style.height = textarea.scrollHeight + 'px'; 
    }
    ['best', 'lotta', 'thea'].forEach(id => {
      const el = elements.fields[id];
      el.addEventListener('input', () => autoResize(el));
      setTimeout(() => autoResize(el), 10);
    });

    // --- AUTHENTIFIZIERUNG ---
    db.auth.getSession().then(({ data: { session } }) => {
      if (session) showApp(session.user);
      else showAuth();
    });

    db.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) showApp(session.user);
      else if (event === 'SIGNED_OUT') showAuth();
    });

    function showAuth() {
      elements.authSection.classList.remove('hidden');
      elements.appSection.classList.add('hidden');
      currentUser = null;
    }

    function showApp(user) {
      currentUser = user;
      elements.authSection.classList.add('hidden');
      elements.appSection.classList.remove('hidden');
      resetEditor();
      loadEntries();
      checkMonthlyReminder();
    }

    $('loginBtn').addEventListener('click', async () => {
      showToast('Anmelden...');
      const { error } = await db.auth.signInWithPassword({
        email: elements.email.value.trim(),
        password: elements.password.value
      });
      if (error) showToast('Fehler: ' + error.message, true);
    });

    $('signupBtn').addEventListener('click', async () => {
      showToast('Registriere...');
      const { error } = await db.auth.signUp({
        email: elements.email.value.trim(),
        password: elements.password.value
      });
      if (error) showToast('Fehler: ' + error.message, true);
      else showToast('Account erstellt! Bitte einloggen.');
    });

    $('logoutBtn').addEventListener('click', () => db.auth.signOut());

    function checkMonthlyReminder() {
        const lastDismissed = localStorage.getItem('last_dismissed_export_month');
        const currentMonth = new Date().toISOString().slice(0, 7); 
        if (lastDismissed !== currentMonth) {
            elements.reminderBox.style.display = 'flex';
        } else {
            elements.reminderBox.style.display = 'none';
        }
    }

    function dismissReminder() {
        const currentMonth = new Date().toISOString().slice(0, 7);
        localStorage.setItem('last_dismissed_export_month', currentMonth);
        elements.reminderBox.style.display = 'none';
    }

    $('remindExportBtn').addEventListener('click', () => {
        exportData('xlsx');
    });

    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    function resetEditor() {
        currentEditingId = null;
        elements.saveBtn.innerHTML = "<span>Speichern</span>";
        elements.cancelEditBtn.classList.add('hidden');
        elements.fields.date.value = new Date().toISOString().split('T')[0];
        elements.fields.best.value = '';
        elements.fields.lotta.value = '';
        elements.fields.thea.value = '';
        selectedMood = null;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        ['best', 'lotta', 'thea'].forEach(id => {
            elements.fields[id].style.height = 'auto'; 
        });
    }

    function startEdit(entry) {
        currentEditingId = entry.id;
        elements.saveBtn.innerHTML = "<span>√Ñnderungen speichern</span>";
        elements.cancelEditBtn.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        elements.fields.date.value = entry.entry_date;
        elements.fields.best.value = entry.best_of_day || '';
        elements.fields.lotta.value = entry.lotta || '';
        elements.fields.thea.value = entry.thea || '';
        selectedMood = entry.mood;
        document.querySelectorAll('.mood-btn').forEach(b => {
            if (b.dataset.mood === entry.mood) b.classList.add('selected');
            else b.classList.remove('selected');
        });
        ['best', 'lotta', 'thea'].forEach(id => autoResize(elements.fields[id]));
    }

    elements.cancelEditBtn.addEventListener('click', resetEditor);

    elements.saveBtn.addEventListener('click', async () => {
      if (!selectedMood) return showToast('Wie war deine Stimmung? üòê', true);
      if (!currentUser) return showToast('Nicht eingeloggt.', true);

      elements.saveBtn.disabled = true;
      const originalHTML = elements.saveBtn.innerHTML;
      elements.saveBtn.innerHTML = "<span>Speichert...</span>";

      const entryData = {
        user_id: currentUser.id,
        entry_date: elements.fields.date.value,
        best_of_day: elements.fields.best.value?.trim() || null,
        lotta: elements.fields.lotta.value?.trim() || null,
        thea: elements.fields.thea.value?.trim() || null,
        mood: selectedMood
      };

      try {
          let error;
          if (currentEditingId) {
              const res = await db.from('entries').update(entryData).eq('id', currentEditingId);
              error = res.error;
          } else {
              const res = await db.from('entries').insert(entryData);
              error = res.error;
          }
          
          if (error) throw error;

          showToast(currentEditingId ? 'Aktualisiert' : 'Gespeichert');
          resetEditor();
          await loadEntries();
      } catch(err) {
          showToast('Fehler: ' + err.message, true);
      } finally {
          elements.saveBtn.disabled = false;
          elements.saveBtn.innerHTML = originalHTML;
      }
    });

    async function loadEntries() {
      elements.entriesContainer.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:40px; font-size:14px;">Lade Eintr√§ge...</div>';
      const { data, error } = await db
        .from('entries')
        .select('*')
        .order('entry_date', { ascending: false })
        .limit(2000);

      if (error) return showToast('Ladefehler: ' + error.message, true);

      allEntriesCache = data || [];
      fuse = new Fuse(allEntriesCache, {
        includeScore: true,
        threshold: 0.4, 
        keys: ['best_of_day', 'lotta', 'thea', 'entry_date']
      });
      renderFilteredEntries();
    }

    function renderFilteredEntries() {
        const searchTerm = elements.searchInput.value.toLowerCase().trim();
        const dateFrom = elements.filterDateFrom.value;
        const dateTo = elements.filterDateTo.value;
        let filtered = allEntriesCache.filter(entry => {
            if (dateFrom && entry.entry_date < dateFrom) return false;
            if (dateTo && entry.entry_date > dateTo) return false;
            return true;
        });
        if (searchTerm.length > 0) {
            const fuseResult = fuse.search(searchTerm).map(r => r.item);
            filtered = filtered.filter(item => fuseResult.includes(item));
        }
        renderDOM(filtered);
    }

    elements.searchInput.addEventListener('input', renderFilteredEntries);
    elements.filterDateFrom.addEventListener('change', renderFilteredEntries);
    elements.filterDateTo.addEventListener('change', renderFilteredEntries);

    function renderDOM(entries) {
      if (!entries.length) {
        elements.entriesContainer.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:60px 0;">Keine Eintr√§ge gefunden.</div>';
        return;
      }
      elements.entriesContainer.innerHTML = entries.map(entry => {
        const moodMap = { 'happy': 'üôÇ', 'neutral': 'üòê', 'sad': 'üòû' };
        const dateObj = new Date(entry.entry_date);
        
        const weekday = dateObj.toLocaleDateString('de-DE', { weekday: 'short' }).toUpperCase();
        const fullDate = dateObj.toLocaleDateString('de-DE', { day: 'numeric', month: 'long', year: 'numeric' });

        return `
          <div class="entry-card">
            <div class="entry-header">
              <span class="entry-date">${weekday}, ${fullDate}</span>
              <span class="entry-mood">${moodMap[entry.mood] || ''}</span>
            </div>
            <div class="entry-content">
              ${entry.best_of_day ? `<div class="entry-block"><div class="entry-text">${escapeHtml(entry.best_of_day)}</div></div>` : ''}
              ${entry.lotta ? `<div class="entry-block"><span class="label-text">Lotta</span><div class="entry-text">${escapeHtml(entry.lotta)}</div></div>` : ''}
              ${entry.thea ? `<div class="entry-block"><span class="label-text">Thea</span><div class="entry-text">${escapeHtml(entry.thea)}</div></div>` : ''}
            </div>
            <div class="entry-footer">
                <span class="action-link edit-link" onclick="window.editEntry('${entry.id}')">Bearbeiten</span>
                <span class="action-link delete-link" onclick="window.deleteEntry('${entry.id}')">L√∂schen</span>
            </div>
          </div>
        `;
      }).join('');
    }

    window.editEntry = (id) => {
        const entry = allEntriesCache.find(e => e.id === id);
        if (entry) startEdit(entry);
    };

    window.deleteEntry = async (id) => {
      if (!window.confirm('Eintrag wirklich l√∂schen?')) return; 
      const { error } = await db.from('entries').delete().eq('id', id);
      if (error) showToast(error.message, true);
      else {
        showToast('Gel√∂scht.');
        allEntriesCache = allEntriesCache.filter(e => e.id !== id);
        fuse.setCollection(allEntriesCache);
        renderFilteredEntries();
      }
    };

    elements.deleteAllBtn.addEventListener('click', async () => {
        if (!confirm('Vorsicht! Willst du wirklich ALLE deine Eintr√§ge unwiderruflich l√∂schen?')) return;
        showToast('L√∂sche alle Eintr√§ge...');
        const { error } = await db.from('entries').delete().eq('user_id', currentUser.id);
        if (error) showToast('Fehler: ' + error.message, true);
        else { showToast('Alle Eintr√§ge gel√∂scht.'); loadEntries(); }
    });

    const popover = elements.exportPopover;
    const trigger = $('exportTriggerBtn');
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = popover.style.display === 'flex';
      popover.style.display = isVisible ? 'none' : 'flex';
    });
    document.addEventListener('click', (e) => {
      if (!trigger.contains(e.target) && !popover.contains(e.target)) popover.style.display = 'none';
    });

    $('exportCsvBtn').addEventListener('click', () => { popover.style.display = 'none'; exportData('csv'); });
    $('exportXlsxBtn').addEventListener('click', () => { popover.style.display = 'none'; exportData('xlsx'); });

    async function exportData(type) {
      showToast(`Exportiere ${type.toUpperCase()}...`);
      const data = allEntriesCache; 
      const moodScore = { 'sad': 1, 'neutral': 2, 'happy': 3 };
      const processedData = data.map(row => ({
          entry_date: row.entry_date,
          best_of_day: row.best_of_day,
          lotta: row.lotta,
          thea: row.thea,
          mood: moodScore[row.mood] || row.mood
      }));
      const filename = `Journal_Backup_${new Date().toISOString().slice(0, 10)}.${type}`;
      if (type === 'csv') {
        const headers = ['entry_date', 'best_of_day', 'lotta', 'thea', 'mood'];
        const csvContent = [headers.join(','), ...processedData.map(row => headers.map(h => `"${String(row[h] || '').replace(/"/g, '""')}"`).join(','))].join('\n');
        downloadBlob(csvContent, filename, 'text/csv;charset=utf-8;');
      } else {
        const ws = XLSX.utils.json_to_sheet(processedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Journal");
        XLSX.writeFile(wb, filename);
      }
      showToast('Export erfolgreich!');
      dismissReminder(); 
    }

    function normalizeDate(val) {
        if (!val) return null;
        const numericVal = Number(val);
        if (typeof XLSX !== 'undefined' && !isNaN(numericVal) && numericVal > 20000 && numericVal < 70000) { 
             try {
                const date = XLSX.utils.numberToDate(numericVal); 
                date.setHours(12);
                return date.toISOString().split('T')[0];
             } catch(e) {}
        }
        const str = String(val).trim();
        if (str.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
            const parts = str.split('.');
            return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
        }
        try {
            const date = new Date(str);
            if (!isNaN(date.getTime())) return date.toISOString().split('T')[0];
        } catch(e) {}
        return null;
    }
    
    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
      return lines.slice(1).map(line => {
        const obj = {};
        let insideQuote = false, currentField = '', colIndex = 0;
        for (let i = 0; i < line.length; i++) {
          const char = line[i], nextChar = line[i + 1];
          if (char === '"') {
            if (insideQuote && nextChar === '"') { currentField += '"'; i++; } 
            else insideQuote = !insideQuote;
          } else if (char === ',' && !insideQuote) {
            if (colIndex < headers.length) obj[headers[colIndex]] = currentField;
            currentField = ''; colIndex++;
          } else currentField += char;
        }
        if (colIndex < headers.length) obj[headers[colIndex]] = currentField;
        return obj;
      }).filter(obj => Object.keys(obj).length > 0);
    }
    
    $('importFile').addEventListener('change', async (e) => {
      if (!currentUser) return showToast('Bitte anmelden.', true);
      const file = e.target.files[0];
      if (!file) return;
      showToast('Importiere Daten...');
      try {
        let rows;
        if (file.name.endsWith('.csv')) { 
            rows = parseCSV(await file.text()); 
        } else { 
            const wb = XLSX.read(await file.arrayBuffer(), { type: 'array' }); 
            rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false }); 
        }
        const entries = rows.map(r => {
            let mood = String(r.mood || '').toLowerCase().trim();
            const moodMap = { '1': 'sad', '2': 'neutral', '3': 'happy' };
            if (moodMap[mood]) mood = moodMap[mood];
            if (!['sad','neutral','happy'].includes(mood)) mood = 'neutral';
            
            const normDate = normalizeDate(r.entry_date);
            const bestText = String(r.best_of_day || '').trim() || null;
            const lottaText = String(r.lotta || '').trim() || null;
            const theaText = String(r.thea || '').trim() || null;
            
            return { 
                user_id: currentUser.id, 
                entry_date: normDate, 
                best_of_day: bestText, 
                lotta: lottaText, 
                thea: theaText, 
                mood: mood, 
                _valid: !!(normDate && (bestText || lottaText || theaText)) 
            };
        }).filter(e => e._valid).map(e => { delete e._valid; return e; }); 

        if (entries.length === 0) return showToast('Keine g√ºltigen Daten.', true);
        const { error } = await db.from('entries').insert(entries);
        if (error) showToast('Fehler: ' + error.message, true);
        else { showToast(`${entries.length} Eintr√§ge importiert.`); loadEntries(); }
      } catch (err) { showToast('Import Fehler: ' + err.message, true); }
      $('importFile').value = ''; 
    });

    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function downloadBlob(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    initTheme();
</script>
</body>
</html>
