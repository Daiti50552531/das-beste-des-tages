<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Das Beste des Tages</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- SheetJS f√ºr Excel-Import/Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Fuse.js f√ºr unscharfe Suche -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  
  <style>
    :root {
      /* Dark Mode (Default) */
      --bg: #000000;
      --card: #1c1c1e;
      --input-bg: #2c2c2e;
      --text: #ffffff;
      --text-secondary: #9898a0;
      --text-matte: #e0e0e0;
      --header-bg: rgba(0, 0, 0, 0.75);
      --border: #38383a;
      --primary: #30d158; /* Apple Green */
      --primary-hover: #28cd41;
      --danger: #ff453a;
      --accent: #0a84ff; /* Apple Blue */
      --warning: #ff9f0a;
      --success: #34d399;
      --error-color: #f87171;
      
      --radius: 14px;
      --shadow: 0 4px 16px rgba(0,0,0,0.3);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body.light-mode {
      --bg: #f2f2f7;
      --card: #ffffff;
      --input-bg: #e5e5ea;
      --text: #000000;
      --text-secondary: #8e8e93;
      --text-matte: #3a3a3c;
      --header-bg: rgba(242, 242, 247, 0.85);
      --border: #d1d1d6;
      --shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding-bottom: 80px; 
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Sticky Header */
    .sticky-header-wrapper {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--header-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      margin-bottom: 20px;
      padding: 16px 0;
      border-bottom: 0.5px solid rgba(128,128,128, 0.2);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 700px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .app-title { font-size: 20px; font-weight: 700; margin: 0; }
    .top-actions { display: flex; align-items: center; gap: 12px; }

    /* Inputs & Cards */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.05);
    }

    label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin: 16px 0 6px;
      padding-left: 2px;
    }
    label:first-of-type { margin-top: 0; }
    
    input, textarea, select {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none; 
      background: var(--input-bg);
      color: var(--text);
      font-size: 16px; 
      font-family: inherit;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      background: var(--card);
      box-shadow: 0 0 0 2px var(--accent); 
    }

    textarea { resize: none; min-height: 86px; line-height: 1.5; }

    /* Buttons */
    .btn {
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--primary); color: #000; } 
    .btn-secondary { background: var(--input-bg); color: var(--text); }
    .btn-danger { background: var(--danger); color: #fff; }
    .text-btn { background: none; color: var(--accent); padding: 4px; font-weight: 500; font-size:16px; border:none; cursor:pointer;}
    .icon-btn { background: var(--input-bg); width:36px; height:36px; border-radius:50%; border:none; color:var(--text); cursor:pointer; font-size:18px;}

    /* Mood Selector */
    .mood-section { margin-top: 32px; margin-bottom: 24px; text-align: center; }
    .mood-buttons { display: inline-flex; background: var(--input-bg); padding: 5px; border-radius: 24px; gap: 2px; }
    .mood-btn { font-size: 28px; width: 60px; height: 50px; border: none; background: transparent; cursor: pointer; border-radius: 20px; opacity: 0.4; }
    .mood-btn.selected { background: var(--card); box-shadow: 0 2px 10px rgba(0,0,0,0.15); opacity: 1; transform: scale(1.05); }

    /* Layout */
    .action-bar { display: flex; gap: 10px; margin-top: 32px; flex-wrap: wrap; }
    .action-bar > * { flex: 1; min-width: 120px; }
    .hidden-input { display: none; }

    /* Filter */
    .filter-wrapper { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .filter-control { flex: 1; min-width: 140px; }

    /* Entries */
    .entries-grid { display: flex; flex-direction: column; gap: 16px; }
    .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .entry-date { font-size: 16px; font-weight: 700; color: var(--text); }
    .entry-mood { font-size: 24px; }
    .entry-block { margin-bottom: 16px; }
    .entry-field-display { background: var(--input-bg); padding: 12px 14px; border-radius: 10px; font-size: 15px; line-height: 1.5; color: var(--text-matte); white-space: pre-wrap; }
    .entry-actions-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(128,128,128,0.1); }
    
    .btn-edit-text { background:none; border:none; color:var(--accent); font-weight:600; cursor:pointer; font-size:14px; }
    .btn-danger-text { background:none; border:none; color:var(--danger); font-weight:600; cursor:pointer; font-size:14px; }

    /* Reminder */
    #reminderBox { display:none; background: rgba(255, 159, 10, 0.1); border: 1px solid var(--warning); padding: 16px; border-radius: 12px; margin-bottom: 24px; }
    .reminder-title { color: var(--warning); font-weight: 700; margin-bottom: 8px; font-size: 15px; }
    .reminder-text { font-size: 14px; opacity: 0.9; margin-bottom: 12px; }

    /* Toast */
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(40,40,40,0.95); backdrop-filter: blur(10px); color: white; padding: 12px 24px; border-radius: 30px; font-weight: 600; z-index: 1000; opacity: 0; transition: all 0.3s; pointer-events: none; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.error { background: rgba(255, 69, 58, 0.95); }

    /* Popover */
    .export-popover { position: absolute; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 200; display: none; flex-direction: column; width: 180px; bottom: 70px; left: 50%; transform: translateX(-50%); }
    .export-popover button { background: transparent; color: var(--text); text-align: left; padding: 12px; border-radius: 8px; font-size: 14px; border: none; cursor: pointer; }
    .export-popover button:hover { background: var(--input-bg); }

    .hidden { display: none !important; }
    .auth-container { max-width: 400px; margin: 10vh auto; text-align: center; }
    .auth-btn-row { margin-top: 24px; display: flex; gap: 10px; }
  </style>
</head>
<body>

  <div id="toast" class="toast">Nachricht</div>

  <!-- AUTH -->
  <div id="authSection" class="auth-container">
    <h1 style="margin-bottom:40px; font-weight:800;">Willkommen</h1>
    <div class="card">
      <label>E-Mail</label>
      <input type="email" id="authEmail" placeholder="name@beispiel.de">
      <label>Passwort</label>
      <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="auth-btn-row">
        <button id="loginBtn" class="btn btn-primary" style="flex:1">Anmelden</button>
        <button id="signupBtn" class="btn btn-secondary" style="flex:1">Registrieren</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appSection" class="hidden">
    
    <div class="sticky-header-wrapper">
        <div class="topbar">
            <h1 class="app-title">Mein Journal</h1>
            <div class="top-actions">
              <button id="themeToggle" class="icon-btn" title="Design">‚òÄÔ∏è</button>
              <button id="logoutBtn" class="text-btn">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
      
      <!-- Reminder -->
      <div id="reminderBox" class="reminder-box">
          <div class="reminder-title">Monats-Backup</div>
          <div class="reminder-text">Denk daran, deine Eintr√§ge diesen Monat zu exportieren.</div>
          <button id="remindExportBtn" class="btn btn-primary" style="font-size:14px; padding:10px;">Jetzt als Excel exportieren</button>
      </div>

      <!-- Editor -->
      <div class="card" id="editorCard">
        <h2 id="editorTitle" style="text-align:center; font-size:13px; margin-bottom:16px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px;">Neuer Eintrag</h2>
        
        <label style="margin-top:0">Datum</label>
        <input type="date" id="entryDate">

        <label>Das Beste des Tages</label>
        <textarea id="bestOfDay" placeholder="Was war heute besonders sch√∂n?"></textarea>

        <label>Lotta</label>
        <textarea id="lotta" placeholder="Neues von Lotta..."></textarea>

        <label>Thea</label>
        <textarea id="thea" placeholder="Neues von Thea..."></textarea>

        <div class="mood-section">
          <div class="mood-label">Stimmung</div>
          <div class="mood-buttons">
            <button class="mood-btn" data-mood="sad">üòû</button>
            <button class="mood-btn" data-mood="neutral">üòê</button>
            <button class="mood-btn" data-mood="happy">üôÇ</button>
          </div>
        </div>

        <div class="action-bar" style="position: relative;">
          <button id="saveBtn" class="btn btn-primary">Speichern</button>
          <button id="cancelEditBtn" class="btn btn-secondary hidden">Abbrechen</button>
          
          <button id="exportTriggerBtn" class="btn btn-secondary">Export</button>
          <label class="btn btn-secondary" style="margin:0; text-align:center; justify-content:center;">
            Import
            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="hidden-input">
          </label>
          
          <button id="deleteAllBtn" class="btn btn-danger" style="flex: 0 0 auto;">Alle Eintr√§ge l√∂schen</button>

          <!-- Export Popover -->
          <div id="exportPopover" class="export-popover">
            <button id="exportCsvBtn">Als CSV</button>
            <button id="exportXlsxBtn">Als Excel</button>
          </div>
        </div>
      </div>

      <!-- Filter -->
      <div class="card" style="padding:16px;">
        <div style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--text-secondary); margin-bottom:12px;">Filter & Suche</div>
        <div class="filter-wrapper">
             <div class="filter-control" style="flex-grow:2">
                 <label>Suchen</label>
                 <input type="text" id="searchInput" placeholder="Stichwort...">
             </div>
             <div class="filter-control">
                 <label>Von</label>
                 <input type="date" id="filterDateFrom">
             </div>
             <div class="filter-control">
                 <label>Bis</label>
                 <input type="date" id="filterDateTo">
             </div>
        </div>
      </div>

      <!-- List -->
      <div id="entriesContainer" class="entries-grid"></div>
    
    </div>
  </div>

  <script>
    console.log('üöÄ App startet...');
    
    const SUPABASE_URL = 'https://gaosbiyccwawuzfjagvm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhb3NiaXljY3dhd3V6ZmphZ3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDYzODAsImV4cCI6MjA3ODY4MjM4MH0.s30-UTEY1xR3DP521ewc03aMRsG3WLH_I5VTi4_xu-4';
    
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let selectedMood = null;
    let allEntriesCache = [];
    let currentEditingId = null;
    let fuse; 

    // Helper
    const $ = id => document.getElementById(id);
    const elements = {
      authSection: $('authSection'), appSection: $('appSection'),
      email: $('authEmail'), password: $('authPassword'),
      entriesContainer: $('entriesContainer'), searchInput: $('searchInput'),
      filterDateFrom: $('filterDateFrom'), filterDateTo: $('filterDateTo'),
      themeToggle: $('themeToggle'), exportPopover: $('exportPopover'),
      saveBtn: $('saveBtn'), deleteAllBtn: $('deleteAllBtn'),
      editorTitle: $('editorTitle'), cancelEditBtn: $('cancelEditBtn'),
      reminderBox: $('reminderBox'),
      fields: { date: $('entryDate'), best: $('bestOfDay'), lotta: $('lotta'), thea: $('thea') }
    };

    function showToast(msg, isError = false) {
      const el = $('toast');
      el.textContent = msg;
      el.className = isError ? 'toast visible error' : 'toast visible';
      setTimeout(() => el.classList.remove('visible'), 3000);
    }

    function initTheme() {
      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
        elements.themeToggle.textContent = 'üåô';
      }
    }
    elements.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      elements.themeToggle.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    function autoResize(textarea) {
      textarea.style.height = 'auto'; 
      textarea.style.height = textarea.scrollHeight + 'px'; 
    }
    ['best', 'lotta', 'thea'].forEach(id => {
      const el = elements.fields[id];
      el.addEventListener('input', () => autoResize(el));
      // Initiale Gr√∂√üe erst wenn sichtbar
    });

    // --- Auth ---
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) showApp(session.user);
    });
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) showApp(session.user);
      else if (event === 'SIGNED_OUT') showAuth();
    });

    function showAuth() {
      elements.authSection.classList.remove('hidden');
      elements.appSection.classList.add('hidden');
      currentUser = null;
    }
    function showApp(user) {
      currentUser = user;
      elements.authSection.classList.add('hidden');
      elements.appSection.classList.remove('hidden');
      resetEditor();
      loadEntries();
      checkMonthlyReminder();
    }

    $('loginBtn').addEventListener('click', async () => {
      showToast('Anmelden...');
      const { error } = await supabase.auth.signInWithPassword({
        email: elements.email.value.trim(), password: elements.password.value
      });
      if (error) showToast(error.message, true);
    });
    $('signupBtn').addEventListener('click', async () => {
      showToast('Registriere...');
      const { error } = await supabase.auth.signUp({
        email: elements.email.value.trim(), password: elements.password.value
      });
      if (error) showToast(error.message, true);
      else showToast('Erfolg! Bitte einloggen.');
    });
    $('logoutBtn').addEventListener('click', () => supabase.auth.signOut());

    // --- Reminder ---
    function checkMonthlyReminder() {
        const lastDismissed = localStorage.getItem('last_dismissed_export_month');
        const currentMonth = new Date().toISOString().slice(0, 7); 
        elements.reminderBox.style.display = (lastDismissed !== currentMonth) ? 'block' : 'none';
    }
    $('remindExportBtn').addEventListener('click', () => { exportData('xlsx'); });

    // --- Editor ---
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    function resetEditor() {
        currentEditingId = null;
        elements.editorTitle.textContent = "Neuer Eintrag";
        elements.saveBtn.innerHTML = "Speichern";
        elements.cancelEditBtn.classList.add('hidden');
        elements.fields.date.value = new Date().toISOString().split('T')[0];
        elements.fields.best.value = ''; elements.fields.lotta.value = ''; elements.fields.thea.value = '';
        selectedMood = null;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        setTimeout(() => ['best', 'lotta', 'thea'].forEach(id => autoResize(elements.fields[id])), 50);
    }

    function startEdit(entry) {
        currentEditingId = entry.id;
        elements.editorTitle.textContent = "Eintrag Bearbeiten";
        elements.saveBtn.innerHTML = "√Ñnderungen speichern";
        elements.cancelEditBtn.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        elements.fields.date.value = entry.entry_date;
        elements.fields.best.value = entry.best_of_day || '';
        elements.fields.lotta.value = entry.lotta || '';
        elements.fields.thea.value = entry.thea || '';
        
        selectedMood = entry.mood;
        document.querySelectorAll('.mood-btn').forEach(b => {
            if (b.dataset.mood === entry.mood) b.classList.add('selected');
            else b.classList.remove('selected');
        });
        setTimeout(() => ['best', 'lotta', 'thea'].forEach(id => autoResize(elements.fields[id])), 50);
    }
    elements.cancelEditBtn.addEventListener('click', resetEditor);

    elements.saveBtn.addEventListener('click', async () => {
      if (!selectedMood) return showToast('Bitte Stimmung w√§hlen! üòê', true);
      if (!currentUser) return showToast('Nicht eingeloggt.', true);

      const oldText = elements.saveBtn.innerText;
      elements.saveBtn.disabled = true;
      elements.saveBtn.innerText = "Speichert...";

      const entryData = {
        user_id: currentUser.id,
        entry_date: elements.fields.date.value,
        best_of_day: elements.fields.best.value || null,
        lotta: elements.fields.lotta.value || null,
        thea: elements.fields.thea.value || null,
        mood: selectedMood
      };

      let error;
      if (currentEditingId) {
          const res = await supabase.from('entries').update(entryData).eq('id', currentEditingId);
          error = res.error;
      } else {
          // Upsert to handle updates on same date
          const res = await supabase.from('entries').upsert(entryData, { onConflict: 'user_id, entry_date' });
          if (res.error && res.error.message.includes('conflict')) {
             // Fallback standard insert
             const retry = await supabase.from('entries').insert(entryData);
             error = retry.error;
          } else {
             error = res.error;
          }
      }
      
      elements.saveBtn.disabled = false;
      elements.saveBtn.innerText = oldText;

      if (error) showToast('Fehler: ' + error.message, true);
      else {
        showToast('Gespeichert! üéâ');
        resetEditor();
        loadEntries();
      }
    });

    // --- Loading & Filtering ---
    async function loadEntries() {
      elements.entriesContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Lade...</div>';
      const { data, error } = await supabase.from('entries').select('*').order('entry_date', { ascending: false }).limit(2000);
      
      if (error) return showToast('Ladefehler: ' + error.message, true);
      allEntriesCache = data || [];
      
      fuse = new Fuse(allEntriesCache, { includeScore: true, threshold: 0.4, keys: ['best_of_day', 'lotta', 'thea', 'entry_date'] });
      renderFilteredEntries();
    }

    function renderFilteredEntries() {
        const term = elements.searchInput.value.toLowerCase().trim();
        const dFrom = elements.filterDateFrom.value;
        const dTo = elements.filterDateTo.value;

        let filtered = allEntriesCache.filter(e => {
            if (dFrom && e.entry_date < dFrom) return false;
            if (dTo && e.entry_date > dTo) return false;
            return true;
        });

        if (term.length > 0) {
            const res = fuse.search(term).map(r => r.item);
            filtered = filtered.filter(item => res.includes(item));
        }
        renderDOM(filtered);
    }
    
    elements.searchInput.addEventListener('input', renderFilteredEntries);
    elements.filterDateFrom.addEventListener('change', renderFilteredEntries);
    elements.filterDateTo.addEventListener('change', renderFilteredEntries);

    function renderDOM(entries) {
      if (!entries.length) {
        elements.entriesContainer.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">Keine Eintr√§ge gefunden.</div>';
        return;
      }
      elements.entriesContainer.innerHTML = entries.map(entry => {
        const moodMap = { 'happy': 'üôÇ', 'neutral': 'üòê', 'sad': 'üòû' };
        const d = new Date(entry.entry_date).toLocaleDateString('de-DE', { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' });
        
        return `
          <div class="entry-card">
            <div class="entry-header">
              <span class="entry-date">${d}</span>
              <span class="entry-mood">${moodMap[entry.mood] || ''}</span>
            </div>
            <div class="entry-body">
              ${entry.best_of_day ? `<div class="entry-block"><span class="label-text">Das Beste</span><div class="entry-field-display">${escapeHtml(entry.best_of_day)}</div></div>` : ''}
              ${entry.lotta ? `<div class="entry-block"><span class="label-text">Lotta</span><div class="entry-field-display">${escapeHtml(entry.lotta)}</div></div>` : ''}
              ${entry.thea ? `<div class="entry-block"><span class="label-text">Thea</span><div class="entry-field-display">${escapeHtml(entry.thea)}</div></div>` : ''}
            </div>
            <div class="entry-actions-row">
                <button class="btn-edit-text" onclick="window.editEntry('${entry.id}')">Bearbeiten</button>
                <button class="btn-danger-text" onclick="window.deleteEntry('${entry.id}')">L√∂schen</button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.editEntry = (id) => {
        const entry = allEntriesCache.find(e => e.id === id);
        if (entry) startEdit(entry);
    };
    window.deleteEntry = async (id) => {
      if (!confirm('Eintrag wirklich l√∂schen?')) return;
      const { error } = await supabase.from('entries').delete().eq('id', id);
      if (error) showToast(error.message, true);
      else {
        showToast('Gel√∂scht.');
        allEntriesCache = allEntriesCache.filter(e => e.id !== id);
        fuse.setCollection(allEntriesCache);
        renderFilteredEntries();
      }
    };

    // --- Delete All ---
    elements.deleteAllBtn.addEventListener('click', async () => {
        if (!confirm('Sicher, dass du ALLE Eintr√§ge l√∂schen willst?')) return;
        showToast('L√∂sche...');
        const { error } = await supabase.from('entries').delete().eq('user_id', currentUser.id);
        if (error) showToast(error.message, true);
        else { showToast('Alles gel√∂scht.'); loadEntries(); }
    });

    // --- Import / Export ---
    const popover = elements.exportPopover;
    const trigger = $('exportTriggerBtn');
    trigger.addEventListener('click', (e) => { e.stopPropagation(); popover.style.display = (popover.style.display === 'flex') ? 'none' : 'flex'; });
    document.addEventListener('click', (e) => { if (!trigger.contains(e.target) && !popover.contains(e.target)) popover.style.display = 'none'; });

    $('exportCsvBtn').addEventListener('click', () => { popover.style.display='none'; exportData('csv'); });
    $('exportXlsxBtn').addEventListener('click', () => { popover.style.display='none'; exportData('xlsx'); });

    async function exportData(type) {
      showToast('Exportiere...');
      const moodScore = { 'sad': 1, 'neutral': 2, 'happy': 3 };
      const processed = allEntriesCache.map(row => ({
          entry_date: row.entry_date,
          best_of_day: row.best_of_day,
          lotta: row.lotta,
          thea: row.thea,
          mood: moodScore[row.mood] || row.mood 
      }));
      const fname = `journal_${new Date().toISOString().slice(0,10)}.${type}`;
      
      if (type === 'csv') {
        const headers = ['entry_date','best_of_day','lotta','thea','mood'];
        const csv = [headers.join(','), ...processed.map(r => headers.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))].join('\n');
        downloadBlob(csv, fname, 'text/csv;charset=utf-8;');
      } else {
        const ws = XLSX.utils.json_to_sheet(processed);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Journal");
        XLSX.writeFile(wb, fname);
      }
      
      showToast('Erledigt! ‚úÖ');
      localStorage.setItem('last_dismissed_export_month', new Date().toISOString().slice(0,7));
      elements.reminderBox.style.display = 'none';
    }

    // --- IMPORT LOGIC (STRICT & ROBUST) ---
    function normalizeDate(val) {
        if (!val) return null;
        const str = String(val).trim();
        
        // 1. ISO YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;

        // 2. German DD.MM.YYYY
        if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(str)) {
            const parts = str.split('.');
            return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
        }

        // 3. Excel Serial Number
        const num = Number(str);
        if (!isNaN(num) && num > 20000 && num < 100000) {
             // 25569 is offset for 1970-01-01
             const date = new Date((num - 25569) * 86400000);
             return date.toISOString().split('T')[0];
        }
        return null;
    }

    $('importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      showToast('Lese Datei...');
      
      try {
        const buffer = await file.arrayBuffer();
        const wb = XLSX.read(buffer, { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false }); // raw: false lets SheetJS try formatting, but we handle logic manually too. Actually raw: true is safer for our custom logic if formatting is weird. Let's use raw: false to get formatted strings if possible, often easier. Actually sticking to your working manual parser logic logic:
        // Better:
        // Use SheetJS standard output.
        
        // Filter & Map
        const entries = rows.map(r => {
            // Find keys loosely
            const keys = Object.keys(r);
            const kDate = keys.find(k => k.match(/date|datum/i)) || 'entry_date';
            const kBest = keys.find(k => k.match(/best|bete/i)) || 'best_of_day';
            const kLotta = keys.find(k => k.match(/lotta/i)) || 'lotta';
            const kThea = keys.find(k => k.match(/thea/i)) || 'thea';
            const kMood = keys.find(k => k.match(/mood|stimmung/i)) || 'mood';

            const rawDate = r[kDate];
            const date = normalizeDate(rawDate);
            if (!date) return null; // Skip invalid date

            const best = r[kBest] || null;
            const lotta = r[kLotta] || null;
            const thea = r[kThea] || null;
            
            // Skip if all content empty
            if (!best && !lotta && !thea) return null;

            // Mood
            const mVal = String(r[kMood] || '').toLowerCase();
            let mood = 'neutral';
            if (mVal.includes('happy') || mVal == '3') mood = 'happy';
            else if (mVal.includes('sad') || mVal == '1') mood = 'sad';

            return {
                user_id: currentUser.id,
                entry_date: date,
                best_of_day: best,
                lotta: lotta,
                thea: thea,
                mood: mood
            };
        }).filter(e => e !== null);

        if (entries.length === 0) {
            return showToast('Keine g√ºltigen Eintr√§ge gefunden (Datum + Inhalt ben√∂tigt).', true);
        }

        showToast(`Importiere ${entries.length} Eintr√§ge...`);
        const { error } = await supabase.from('entries').upsert(entries, { onConflict: 'user_id, entry_date' });
        
        if (error) throw error;
        
        showToast(`Erfolg! ${entries.length} importiert.`);
        loadEntries();
      } catch (err) {
        showToast('Fehler: ' + err.message, true);
      }
      $('importFile').value = ''; 
    });

    // --- Utils ---
    function escapeHtml(t) { return t ? String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ''; }
    function downloadBlob(content, fname, mime) {
      const url = URL.createObjectURL(new Blob([content], {type:mime}));
      const a = document.createElement('a'); a.href=url; a.download=fname; a.click();
    }

    initTheme();
  </script>
</body>
</html>
