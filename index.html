<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Das Beste des Tages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --border:#ddd; --muted:#666; --active:#2b8a3e;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { max-width: 640px; margin: 0 auto; padding: 16px; border: 1px solid var(--border); border-radius: 12px; }
    .row { margin: 12px 0; }
    textarea, button, input { font-size: 16px; }
    textarea { width: 100%; padding: 10px; resize: vertical; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color: var(--muted); font-size: 14px; }
    .list { margin-top: 12px; }
    .hide { display:none; }

    .moods { display:flex; gap:10px; }
    .mood-btn {
      font-size: 22px; line-height: 1;
      border: 1px solid var(--border); border-radius: 8px;
      background: #fff; padding: 8px 10px; cursor: pointer;
      transition: transform .05s ease-in-out, border-color .1s;
    }
    .mood-btn:active { transform: scale(0.98); }
    .mood-btn.active { border-color: var(--active); box-shadow: inset 0 0 0 2px var(--active)20; }
    .entry { padding:8px 0; border-bottom:1px solid #eee; }
    .entry-date { font-weight:600; }
  </style>
</head>
<body>
  <!-- Hinweis, falls ?k=... fehlt -->
  <div id="guard" class="card">
    <h2>Zugriff</h2>
    <p class="muted">
      Diese App wird √ºber einen geheimen Link ge√∂ffnet. Bitte nutze die URL mit
      <code>?k=DEIN_GEHEIMNIS</code>.
    </p>
  </div>

  <!-- App -->
  <div id="app" class="card hide">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h2>Das Beste des Tages</h2>
      <div class="muted">Privater Link aktiv</div>
    </div>

    <div class="row">
      <label>Wie war deine Stimmung?</label>
      <div class="moods">
        <button class="mood-btn" data-mood="sad"     type="button" title="traurig">üòû</button>
        <button class="mood-btn" data-mood="neutral" type="button" title="neutral">üòê</button>
        <button class="mood-btn" data-mood="happy"   type="button" title="fr√∂hlich">üôÇ</button>
      </div>
    </div>

    <div class="row">
      <textarea id="note" rows="3" placeholder="Notiz‚Ä¶"></textarea>
    </div>

    <div class="row toolbar">
      <button id="save"   type="button">Eintrag speichern</button>
      <button id="export" type="button">üì• Export CSV</button>
      <input  id="import-file" type="file" accept=".csv" />
      <button id="import" type="button">üì§ Import CSV</button>
    </div>

    <h3>Meine Eintr√§ge</h3>
    <div id="entries" class="list"></div>
  </div>

  <script>
    // ========= Konfiguration =========
    const SUPABASE_URL = "https://xxxxxxxxxxxx.supabase.co"; // <-- anpassen
    const SUPABASE_ANON_KEY = "eyJhbGciOi...";                // <-- anpassen
    const EDGE_FN = `${SUPABASE_URL}/functions/v1/entries`;   // Function-Name = "entries"

    // Geheimes Link-Token aus URL (?k=...)
    const params = new URLSearchParams(location.search);
    const LINK_KEY = params.get('k') || "";

    // Sichtbarkeit
    const guard = document.getElementById('guard');
    const app   = document.getElementById('app');
    const showApp = (ok) => { app.classList.toggle('hide', !ok); guard.classList.toggle('hide', ok); };

    // ========= UI-State =========
    let currentMood = null;
    const moodButtons = Array.from(document.querySelectorAll('.mood-btn'));
    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentMood = btn.dataset.mood;
        moodButtons.forEach(b => b.classList.toggle('active', b === btn));
      });
    });

    const renderEntries = (rows=[]) => {
      const root = document.getElementById('entries');
      if (!rows.length) { root.innerHTML = '<div class="muted">Noch keine Eintr√§ge.</div>'; return; }
      root.innerHTML = rows.map(r => `
        <div class="entry">
          <div class="entry-date">${(r.created_at || '').slice(0,10)} ‚Äì ${r.mood || ''}</div>
          <div>${(r.note || '').replace(/</g,'&lt;')}</div>
        </div>
      `).join('');
    };

    // ========= Edge Function Call =========
    async function callEntries(method, body) {
      const headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, // erforderlich f√ºr Functions
        "x-link-key": LINK_KEY                           // unser geheimer Schl√ºssel
      };
      const res = await fetch(EDGE_FN, { method, headers, body: body ? JSON.stringify(body) : undefined });
      const text = await res.text();
      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
      try { return JSON.parse(text); } catch { return text; }
    }

    async function loadEntries() {
      try {
        const data = await callEntries("POST", { action: "list" }); // holt aus diary_entries
        renderEntries(data || []);
      } catch (e) {
        console.error(e);
        alert("Laden fehlgeschlagen: " + e.message);
      }
    }

    // ========= Aktionen =========
    document.getElementById('save').addEventListener('click', async () => {
      const note = document.getElementById('note').value.trim();
      if (!currentMood && !note) return alert('Bitte Stimmung oder Notiz eingeben.');
      try {
        await callEntries("POST", { action: "insert", payload: { mood: currentMood, note } });
        document.getElementById('note').value = '';
        currentMood = null;
        moodButtons.forEach(b => b.classList.remove('active'));
        await loadEntries();
      } catch (e) {
        console.error(e);
        alert('Speichern fehlgeschlagen: ' + e.message);
      }
    });

    document.getElementById('export').addEventListener('click', async () => {
      try {
        const rows = await callEntries("POST", { action: "listAsc" });
        const header = ['created_at','mood','note'];
        const lines = [header.join(',')].concat(
          (rows || []).map(r => {
            const vals = [r.created_at, r.mood, (r.note || '').replace(/"/g,'""')];
            return vals.map(v => `"${(v ?? '')}"`).join(',');
          })
        );
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'entries.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      } catch (e) {
        console.error(e);
        alert('Export fehlgeschlagen: ' + e.message);
      }
    });

    document.getElementById('import').addEventListener('click', async () => {
      const file = document.getElementById('import-file').files[0];
      if (!file) return alert('Bitte CSV ausw√§hlen.');
      const text = await file.text();
      const rows = text.split(/\r?\n/).slice(1).filter(Boolean).map(line => {
        const m = line.match(/^"([^"]*)","([^"]*)","([^"]*)"$/);
        if (!m) return null;
        return { created_at: m[1], mood: m[2], note: m[3].replace(/""/g,'"') };
      }).filter(Boolean);
      try {
        await callEntries("POST", { action: "bulkInsert", payload: rows });
        await loadEntries();
      } catch (e) {
        console.error(e);
        alert('Import fehlgeschlagen: ' + e.message);
      }
    });

    // ========= Start =========
    if (LINK_KEY) { showApp(true); loadEntries(); }
    else          { showApp(false); }
  </script>
</body>
</html>
