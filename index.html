<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Das Beste des Tages</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- SheetJS f√ºr Excel-Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Fuse.js f√ºr unscharfe Suche -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  
  <style>
    :root {
      /* Dark Mode (Default) variables */
      --bg: #000000;
      --card: #1c1c1e;
      --input-bg: #2c2c2e;
      
      --text: #ffffff;
      --text-secondary: #9898a0; /* Cooler Grey (Apple suggestion) */
      --text-matte: #e0e0e0;     /* New: Matte White for entries */
      
      --header-bg: rgba(0, 0, 0, 0.75); /* Translucent Header */
      
      --border: #38383a;
      --primary: #30d158; /* Apple Green */
      --primary-hover: #28cd41;
      --danger: #ff453a;
      --accent: #0a84ff; /* Apple Blue */
      
      --radius: 14px; /* Slightly rounder */
      --shadow: 0 4px 16px rgba(0,0,0,0.3);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Light Mode variables */
    body.light-mode {
      --bg: #f2f2f7;
      --card: #ffffff;
      --input-bg: #e5e5ea;
      
      --text: #000000;
      --text-secondary: #8e8e93;
      --text-matte: #3a3a3c; /* Matte Dark for Light Mode */
      
      --header-bg: rgba(242, 242, 247, 0.85);
      
      --border: #d1d1d6;
      --shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
      padding-bottom: 80px; /* Space for scroll */
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Typography */
    h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; text-align: center; margin-bottom: 24px; }
    
    /* Cards */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      transition: background 0.3s ease;
    }
    
    /* STICKY HEADER (Glassmorphism) */
    .sticky-header-wrapper {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--header-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      margin-bottom: 20px;
      padding: 16px 0;
      border-bottom: 0.5px solid rgba(128,128,128, 0.1);
      /* Negative margin to span full width on mobile if inside padded container */
      margin-left: -20px;
      margin-right: -20px;
      padding-left: 20px;
      padding-right: 20px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 700px;
      margin: 0 auto;
    }
    
    .app-title {
        font-size: 20px; /* Sligthly smaller for header */
        font-weight: 700;
        margin: 0;
        text-align: left;
    }
    
    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Buttons Interaction (Snappy Feel) */
    button, .btn, .icon-btn, .mood-btn {
        transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
    }
    button:active, .btn:active, .icon-btn:active, .mood-btn:active {
        transform: scale(0.94); /* Visual Haptic Feedback */
        opacity: 0.7;
    }

    /* Text Buttons (Logout) */
    .text-btn {
        background: none;
        border: none;
        color: var(--accent);
        font-size: 16px;
        cursor: pointer;
        padding: 6px 10px;
        font-weight: 500;
    }
    
    /* Icon Buttons (Theme) */
    .icon-btn {
      background: var(--input-bg);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      color: var(--text);
    }

    /* Inputs & Labels */
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin: 20px 0 8px;
      letter-spacing: 0.5px;
      padding-left: 4px;
    }
    label:first-of-type { margin-top: 0; }
    
    input, textarea {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none; 
      background: var(--input-bg);
      color: var(--text);
      font-size: 17px; 
      font-family: inherit;
      transition: background 0.2s, box-shadow 0.2s;
    }
    
    input:focus, textarea:focus {
      outline: none;
      background: var(--card);
      box-shadow: 0 0 0 2px var(--accent); 
    }

    textarea {
      resize: none;
      min-height: 86px; 
      overflow-y: hidden;
      line-height: 1.5;
    }

    /* Mood Selector */
    .mood-section {
      margin-top: 32px;
      margin-bottom: 24px;
      text-align: center;
    }
    .mood-label {
        font-size:12px; 
        color: var(--text-secondary); 
        text-transform:uppercase; 
        font-weight:600; 
        margin-bottom: 12px;
        letter-spacing: 0.5px;
    }
    .mood-buttons {
      display: inline-flex;
      background: var(--input-bg);
      padding: 5px;
      border-radius: 24px;
      gap: 2px;
    }
    .mood-btn {
      font-size: 28px;
      width: 60px;
      height: 50px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.4; 
    }
    .mood-btn:hover { opacity: 0.7; }
    .mood-btn.selected {
      background: var(--card);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      opacity: 1;
      transform: scale(1.05); /* Slight grow */
    }
    /* Reset active state for selected mood button specifically if needed, 
       but global button rule handles the press down nicely */

    /* Action Buttons Area */
    .action-bar {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
    }
    
    .btn-primary { background: var(--primary); color: #000; } 
    .btn-secondary { background: var(--input-bg); color: var(--text); }
    
    .btn-danger-text { 
        background: transparent; 
        color: var(--danger); 
        padding: 10px 0; 
        font-size: 14px; 
        font-weight: 500;
        border: none;
        cursor: pointer;
        margin-top: 4px;
        text-align: left;
        width: 100%;
    }

    .hidden-input { display: none; }

    /* Search Bar */
    .search-wrapper {
      position: relative;
      margin-bottom: 24px;
    }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }
    input[type="search"] {
      padding-left: 40px; 
      background: var(--input-bg); 
      /* Make search bar slightly translucent too? No, solid is better for contrast */
    }

    /* Entries List */
    .entries-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .entry-card {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      position: relative;
    }
    
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .entry-date { font-size: 16px; font-weight: 700; color: var(--text); }
    .entry-mood { font-size: 26px; }
    
    .entry-block { margin-bottom: 20px; }
    
    .label-text {
      color: var(--text-secondary); 
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 6px;
      display: block;
      letter-spacing: 0.5px;
      padding-left: 2px;
    }
    
    /* MATTE WHITE TEXT BOX */
    .entry-field-display {
        background: var(--input-bg);
        padding: 14px 16px;
        border-radius: 10px;
        font-size: 16px;
        line-height: 1.6;
        color: var(--text-matte); /* Matte White */
        white-space: pre-wrap; 
    }

    /* Export Modal/Popover */
    .export-popover {
      position: absolute;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 200;
      display: none;
      flex-direction: column;
      width: 180px;
      bottom: 70px; 
      left: 50%;
      transform: translateX(-50%);
    }
    .export-popover button {
      background: transparent;
      color: var(--text);
      text-align: left;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      border: none;
      cursor: pointer;
    }
    .export-popover button:hover { background: var(--input-bg); }

    .hidden { display: none !important; }
    
    /* Messages */
    .toast {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(40, 40, 40, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .toast.visible { opacity: 1; }

    /* Auth Screen */
    .auth-container {
      max-width: 400px;
      margin: 10vh auto;
      text-align: center;
      padding: 0 20px;
    }
    .auth-btn-row { margin-top: 24px; display: flex; gap: 10px; }

  </style>
</head>
<body>

  <div id="toast" class="toast">Nachricht</div>

  <!-- AUTH SECTION (No Sticky Header) -->
  <div id="authSection" class="auth-container">
    <h1 style="margin-bottom:40px; font-weight:800;">Willkommen</h1>
    <div class="card">
      <label>E-Mail Adresse</label>
      <input type="email" id="authEmail" placeholder="name@beispiel.de">
      
      <label>Passwort</label>
      <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      
      <div class="auth-btn-row">
        <button id="loginBtn" class="btn btn-primary">Anmelden</button>
        <button id="signupBtn" class="btn btn-secondary">Registrieren</button>
      </div>
    </div>
  </div>

  <!-- APP SECTION -->
  <div id="appSection" class="hidden">
    
    <!-- STICKY HEADER -->
    <div class="sticky-header-wrapper">
        <div class="container topbar">
            <h1 class="app-title">Das Beste des Tages</h1>
            <div class="top-actions">
              <button id="themeToggle" class="icon-btn" title="Design umschalten">‚òÄÔ∏è</button>
              <button id="logoutBtn" class="text-btn">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
      
      <!-- Create Entry Card -->
      <div class="card">
        <label style="margin-top:0">Datum</label>
        <input type="date" id="entryDate">

        <label>Das Beste des Tages</label>
        <textarea id="bestOfDay" placeholder="Was war heute besonders sch√∂n?"></textarea>

        <label>Lotta</label>
        <textarea id="lotta" placeholder="Neues von Lotta..."></textarea>

        <label>Thea</label>
        <textarea id="thea" placeholder="Neues von Thea..."></textarea>

        <!-- Mood Selector -->
        <div class="mood-section">
          <div class="mood-label">Stimmung</div>
          <div class="mood-buttons">
            <button class="mood-btn" data-mood="sad">üòû</button>
            <button class="mood-btn" data-mood="neutral">üòê</button>
            <button class="mood-btn" data-mood="happy">üôÇ</button>
          </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar" style="position: relative;">
          <button id="saveBtn" class="btn btn-primary">
            <span>Speichern</span>
          </button>
          
          <button id="exportTriggerBtn" class="btn btn-secondary">
            <span>Export</span>
          </button>
          
          <label class="btn btn-secondary" style="margin:0;">
            <span>Import</span>
            <input type="file" id="importFile" accept=".csv,.xlsx" class="hidden-input">
          </label>

          <!-- Export Choice Popover -->
          <div id="exportPopover" class="export-popover">
            <button id="exportCsvBtn">Als CSV exportieren</button>
            <button id="exportXlsxBtn">Als Excel exportieren</button>
          </div>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="search" id="searchInput" placeholder="Suche in deinen Eintr√§gen...">
      </div>

      <!-- Entries List -->
      <div id="entriesContainer" class="entries-grid">
        <!-- Entries will be loaded here -->
      </div>
    
    </div> <!-- End Container -->
  </div> <!-- End App Section -->

  <script>
    console.log('üöÄ App startet...');
    
    // --- KONFIGURATION ---
    const SUPABASE_URL = 'https://gaosbiyccwawuzfjagvm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhb3NiaXljY3dhd3V6ZmphZ3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDYzODAsImV4cCI6MjA3ODY4MjM4MH0.s30-UTEY1xR3DP521ewc03aMRsG3WLH_I5VTi4_xu-4';
    
    // --- INITIALISIERUNG ---
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Globale Variablen
    let currentUser = null;
    let selectedMood = null;
    let allEntriesCache = []; // F√ºr die Suche
    let fuse; // Search Engine Instance

    // DOM Elemente
    const $ = id => document.getElementById(id);
    const elements = {
      authSection: $('authSection'),
      appSection: $('appSection'),
      email: $('authEmail'),
      password: $('authPassword'),
      entriesContainer: $('entriesContainer'),
      searchInput: $('searchInput'),
      themeToggle: $('themeToggle'),
      exportPopover: $('exportPopover'),
      fields: {
        date: $('entryDate'),
        best: $('bestOfDay'),
        lotta: $('lotta'),
        thea: $('thea')
      }
    };

    // --- THEME LOGIC ---
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        elements.themeToggle.textContent = 'üåô';
      }
    }
    
    elements.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      elements.themeToggle.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    // --- AUTO RESIZE TEXTAREAS ---
    function autoResize(textarea) {
      textarea.style.height = 'auto'; // Reset
      textarea.style.height = textarea.scrollHeight + 'px'; // Set to content height
    }

    ['best', 'lotta', 'thea'].forEach(id => {
      const el = elements.fields[id];
      el.addEventListener('input', () => autoResize(el));
      // Initiale Gr√∂√üe beim Laden
      autoResize(el);
    });

    // --- AUTHENTIFIZIERUNG ---
    
    // Check Session on Load
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) showApp(session.user);
      else showAuth();
    });

    // Auth State Listener
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) showApp(session.user);
      else if (event === 'SIGNED_OUT') showAuth();
    });

    // Background Freeze Fix
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          currentUser = session.user;
          loadEntries();
        } else {
          showAuth();
        }
      }
    });

    function showAuth() {
      elements.authSection.classList.remove('hidden');
      elements.appSection.classList.add('hidden');
      currentUser = null;
    }

    function showApp(user) {
      currentUser = user;
      elements.authSection.classList.add('hidden');
      elements.appSection.classList.remove('hidden');
      
      // Default Date: Today
      elements.fields.date.value = new Date().toISOString().split('T')[0];
      loadEntries();
    }

    $('loginBtn').addEventListener('click', async () => {
      showToast('Anmelden...');
      const { error } = await supabase.auth.signInWithPassword({
        email: elements.email.value.trim(),
        password: elements.password.value
      });
      if (error) showToast('Fehler: ' + error.message, true);
    });

    $('signupBtn').addEventListener('click', async () => {
      showToast('Registriere...');
      const { error } = await supabase.auth.signUp({
        email: elements.email.value.trim(),
        password: elements.password.value
      });
      if (error) showToast('Fehler: ' + error.message, true);
      else showToast('Registrierung erfolgreich! Bitte einloggen.');
    });

    $('logoutBtn').addEventListener('click', () => supabase.auth.signOut());

    // --- EINTRAG ERSTELLEN ---

    // Mood Selection
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    // Save
    $('saveBtn').addEventListener('click', async () => {
      if (!selectedMood) return showToast('Bitte Stimmung w√§hlen! üòê', true);
      if (!currentUser) return showToast('Nicht eingeloggt.', true);

      showToast('Speichere...');
      
      const entry = {
        user_id: currentUser.id,
        entry_date: elements.fields.date.value,
        best_of_day: elements.fields.best.value || null,
        lotta: elements.fields.lotta.value || null,
        thea: elements.fields.thea.value || null,
        mood: selectedMood
      };

      const { error } = await supabase.from('entries').insert(entry);
      
      if (error) {
        showToast('Fehler: ' + error.message, true);
      } else {
        showToast('Gespeichert! üéâ');
        // Reset Inputs
        elements.fields.best.value = '';
        elements.fields.lotta.value = '';
        elements.fields.thea.value = '';
        selectedMood = null;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        // Reset Height
        ['best', 'lotta', 'thea'].forEach(id => autoResize(elements.fields[id]));
        
        loadEntries();
      }
    });

    // --- DATEN LADEN & SUCHE ---

    async function loadEntries() {
      elements.entriesContainer.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">Lade...</div>';
      
      const { data, error } = await supabase
        .from('entries')
        .select('*')
        .order('entry_date', { ascending: false })
        .limit(1000);

      if (error) return showToast('Ladefehler: ' + error.message, true);

      allEntriesCache = data || [];
      
      // Fuse.js
      const options = {
        includeScore: true,
        threshold: 0.4, 
        keys: ['best_of_day', 'lotta', 'thea', 'entry_date']
      };
      fuse = new Fuse(allEntriesCache, options);

      renderEntries(allEntriesCache);
    }

    function renderEntries(entries) {
      if (!entries.length) {
        elements.entriesContainer.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:40px;">Keine Eintr√§ge gefunden.</div>';
        return;
      }

      elements.entriesContainer.innerHTML = entries.map(entry => {
        const moodMap = { 'happy': 'üôÇ', 'neutral': 'üòê', 'sad': 'üòû' };
        const displayDate = new Date(entry.entry_date).toLocaleDateString('de-DE', { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' });

        return `
          <div class="entry-card">
            <div class="entry-header">
              <span class="entry-date">${displayDate}</span>
              <span class="entry-mood">${moodMap[entry.mood] || ''}</span>
            </div>
            <div class="entry-body">
              ${entry.best_of_day ? `
                <div class="entry-block">
                    <span class="label-text">Das Beste des Tages</span>
                    <div class="entry-field-display">${escapeHtml(entry.best_of_day)}</div>
                </div>` : ''}
              
              ${entry.lotta ? `
                <div class="entry-block">
                    <span class="label-text">Lotta</span>
                    <div class="entry-field-display">${escapeHtml(entry.lotta)}</div>
                </div>` : ''}

              ${entry.thea ? `
                <div class="entry-block">
                    <span class="label-text">Thea</span>
                    <div class="entry-field-display">${escapeHtml(entry.thea)}</div>
                </div>` : ''}
            </div>
            <button class="btn-danger-text" onclick="deleteEntry('${entry.id}')">Eintrag l√∂schen</button>
          </div>
        `;
      }).join('');
    }

    // Such-Logik
    elements.searchInput.addEventListener('input', (e) => {
      const term = e.target.value;
      if (!term) {
        renderEntries(allEntriesCache);
        return;
      }
      const result = fuse.search(term);
      const filtered = result.map(r => r.item);
      renderEntries(filtered);
    });

    // Delete
    window.deleteEntry = async (id) => {
      if (!confirm('Eintrag wirklich l√∂schen?')) return;
      const { error } = await supabase.from('entries').delete().eq('id', id);
      if (error) showToast(error.message, true);
      else {
        allEntriesCache = allEntriesCache.filter(e => e.id !== id);
        fuse.setCollection(allEntriesCache);
        const term = elements.searchInput.value;
        if(term) {
             const result = fuse.search(term);
             renderEntries(result.map(r => r.item));
        } else {
             renderEntries(allEntriesCache);
        }
        showToast('Gel√∂scht.');
      }
    };

    // --- IMPORT / EXPORT ---

    const popover = elements.exportPopover;
    const trigger = $('exportTriggerBtn');
    
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = popover.style.display === 'flex';
      popover.style.display = isVisible ? 'none' : 'flex';
    });

    document.addEventListener('click', (e) => {
      if (!trigger.contains(e.target) && !popover.contains(e.target)) {
        popover.style.display = 'none';
      }
    });

    $('exportCsvBtn').addEventListener('click', async () => {
      popover.style.display = 'none';
      exportData('csv');
    });

    $('exportXlsxBtn').addEventListener('click', async () => {
      popover.style.display = 'none';
      exportData('xlsx');
    });

    async function exportData(type) {
      showToast(`Exportiere ${type.toUpperCase()}...`);
      const { data, error } = await supabase.from('entries').select('*').order('entry_date');
      if (error) return showToast(error.message, true);

      // Mood Mapping: sad=1, neutral=2, happy=3
      const moodScore = { 'sad': 1, 'neutral': 2, 'happy': 3 };

      const processedData = data.map(row => ({
          ...row,
          mood: moodScore[row.mood] || row.mood 
      }));

      if (type === 'csv') {
        const headers = ['entry_date', 'best_of_day', 'lotta', 'thea', 'mood'];
        const csvContent = [
          headers.join(','),
          ...processedData.map(row => headers.map(h => `"${String(row[h]||'').replace(/"/g, '""')}"`).join(','))
        ].join('\n');
        downloadBlob(csvContent, 'journal_export.csv', 'text/csv');
      } else {
        const ws = XLSX.utils.json_to_sheet(processedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Journal");
        XLSX.writeFile(wb, 'journal_export.xlsx');
      }
    }

    $('importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      showToast('Importiere...');
      
      try {
        let rows;
        if (file.name.endsWith('.csv')) {
          const text = await file.text();
          rows = parseCSV(text);
        } else {
          const buffer = await file.arrayBuffer();
          const wb = XLSX.read(buffer);
          rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        }

        const entries = rows.map(r => ({
          user_id: currentUser.id,
          entry_date: r.entry_date || r.date || new Date().toISOString().split('T')[0],
          best_of_day: r.best_of_day || r.best || null,
          lotta: r.lotta || null,
          thea: r.thea || null,
          mood: ['sad','neutral','happy'].includes(r.mood) ? r.mood : 'neutral'
        }));

        const { error } = await supabase.from('entries').insert(entries);
        if (error) throw error;
        
        showToast(`${entries.length} Eintr√§ge importiert!`);
        loadEntries();
      } catch (err) {
        showToast('Import Fehler: ' + err.message, true);
      }
      $('importFile').value = ''; 
    });

    // Helpers
    function showToast(msg, isError = false) {
      const el = $('toast');
      el.textContent = msg;
      el.style.background = isError ? 'rgba(255, 69, 58, 0.95)' : 'rgba(48, 209, 88, 0.95)';
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 3000);
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function downloadBlob(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    
    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      return lines.slice(1).map(line => {
        const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
        const obj = {};
        headers.forEach((h, i) => obj[h] = vals[i]);
        return obj;
      });
    }

    initTheme();
  </script>
</body>
</html>
